<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini Visionary — AI Poster Generator</title>
  <link rel="icon" href="/logo.png" />
  <meta name="mv-username" content="">
  <script>
    // Bootstrap data for immediate render
    window.__BOOTSTRAP__ = { username: "" };

    // Load cached username BEFORE page renders to eliminate flicker
    (function() {
      try {
        const cached = localStorage.getItem('cached_user_data');
        if (cached) {
          const userData = JSON.parse(cached);
          if (userData.display_name) {
            window.__BOOTSTRAP__.username = userData.display_name;
          }
        }
      } catch(e) {}
    })();
  </script>
  <style>
    :root{
      --bg-0:#0b0f19; --bg-1:#0f1629; --card:#0e1424; --sunken:#0b1020;
      --line:#3b82f6; --text:#e6eaf2; --muted:#9aa4b2; --ring:rgba(148,163,184,.25);
      --btn-start:#22d3ee; --btn-end:#ec4899;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text); height:100vh; display:flex; flex-direction:column;
      background:
        radial-gradient(1200px 600px at 10% -10%, #16213a 0%, transparent 60%),
        radial-gradient(1200px 600px at 110% 110%, #1b2a4b 0%, transparent 60%),
        linear-gradient(180deg, var(--bg-0), var(--bg-1));
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    }
    .header{display:flex; justify-content:space-between; align-items:center; padding:16px 24px; border-bottom:1px solid var(--ring); position:relative; z-index:100}
    .header-left{display:flex; align-items:center; gap:12px}
    .sidebar-toggle{display:none; background:none; border:none; color:var(--text); font-size:18px; cursor:pointer; padding:8px}
    .logo{display:flex; align-items:center; gap:12px; font-size:20px; font-weight:700; text-decoration:none; color:var(--text)}
    .logo img{width:32px; height:32px; border-radius:8px}
    .nav{display:flex; gap:16px; align-items:center}
    .nav a{color:var(--muted); text-decoration:none; padding:8px 12px; border-radius:8px; transition:all 0.2s}
    .nav a:hover{color:var(--text); background:var(--sunken)}
    .credits-display{color:var(--text); font-weight:600; padding:8px 12px; font-size:14px}
    .logout-btn{background:none; border:1px solid var(--ring); color:var(--muted); padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px}
    .logout-btn:hover{color:var(--text); border-color:var(--text)}

    /* Sidebar */
    .sidebar{position:fixed; top:0; left:0; width:280px; height:100vh; background:var(--card); border-right:1px solid var(--ring); z-index:200; transform:translateX(-100%); transition:transform 0.3s ease; display:flex; flex-direction:column}
    .sidebar.open{transform:translateX(0)}
    .sidebar-header{padding:16px; border-bottom:1px solid var(--ring)}
    .new-chat-btn{width:100%; background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); color:#081018; font-weight:700; border:none; border-radius:12px; padding:12px; cursor:pointer; transition:all 0.2s}
    .new-chat-btn:hover{transform:translateY(-1px)}
    .sidebar-title{padding:16px 16px 8px; font-size:12px; text-transform:uppercase; letter-spacing:0.5px; color:var(--muted)}
    .mini-library{max-height:200px; overflow-y:auto; padding:0 12px; margin-bottom:16px}
    .library-grid{display:grid; grid-template-columns:repeat(3, 1fr); gap:8px}
    .library-item{position:relative; aspect-ratio:1; border-radius:8px; overflow:hidden; cursor:pointer; transition:transform 0.2s}
    .library-item:hover{transform:scale(1.05)}
    .library-item img{width:100%; height:100%; object-fit:cover}
    .library-item-overlay{position:absolute; bottom:0; left:0; right:0; background:linear-gradient(transparent, rgba(0,0,0,0.8)); padding:4px; opacity:0; transition:opacity 0.2s}
    .library-item:hover .library-item-overlay{opacity:1}
    .library-count{font-size:11px; color:var(--muted); text-align:center; padding:8px}
    .chat-sessions{flex:1; overflow-y:auto; padding:0 12px}
    .session-item{display:flex; align-items:center; justify-content:space-between; padding:12px; margin:4px 0; border-radius:12px; cursor:pointer; transition:all 0.2s; border:1px solid transparent}
    .session-item:hover{background:var(--sunken)}
    .session-item.active{background:var(--sunken); border:1px solid var(--ring)}
    .session-content{flex:1; display:flex; flex-direction:column; gap:2px}
    .session-title{color:var(--text); font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .session-date{color:var(--muted); font-size:12px}
    .session-actions{display:flex; gap:4px; opacity:0; transition:opacity 0.2s}
    .session-item:hover .session-actions{opacity:1}
    .session-action{background:none; border:none; color:var(--muted); padding:4px; border-radius:4px; cursor:pointer; display:flex; align-items:center; justify-content:center}
    .session-action:hover{color:var(--text); background:var(--sunken)}
    .session-action.delete:hover{color:#ef4444}
    .sidebar-footer{padding:16px; border-top:1px solid var(--ring); margin-top:auto; text-align:center}
    .sidebar-brand{font-weight:700; color:var(--text); margin-bottom:8px}
    .sidebar-logo{width:240px; height:240px; border-radius:40px; margin:20px auto; display:block}
    .sidebar-tagline{font-size:12px; color:var(--muted)}
    .sidebar-overlay{position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:150; opacity:0; visibility:hidden; transition:all 0.3s ease}
    .sidebar-overlay.show{opacity:1; visibility:visible}

    @media (max-width: 768px) {
      .sidebar-toggle{display:block}
      .main-content{margin-left:0}
    }
    @media (min-width: 769px) {
      .sidebar{transform:translateX(0)}
      .main-content{margin-left:280px}
      .sidebar-overlay{display:none}
    }

    .main-content{flex:1; display:flex; flex-direction:column; max-width:1000px; margin:0 auto; padding:24px; transition:margin-left 0.3s ease}

    .welcome-section{flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:40px 20px; margin-left:200px}
    .welcome-title{font-size:2.5rem; font-weight:800; margin-bottom:32px; background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); background-clip:text; -webkit-background-clip:text; color:transparent}

    .input-container{display:flex; flex-direction:column; gap:8px; background:var(--sunken); border:1px solid var(--ring); border-radius:16px; padding:12px; margin-bottom:16px; min-width:600px}
    .input-wrapper{display:flex; align-items:end; gap:12px; width:100%}
    .main-textarea, .chat-textarea{flex:1; background:transparent; border:none; outline:none; color:var(--text); font-family:inherit; resize:none; min-height:44px; max-height:120px}
    .reference-preview{display:none; align-items:center; gap:8px; padding:8px; background:var(--card); border:1px solid var(--ring); border-radius:8px; margin-bottom:8px}
    .reference-preview img{width:60px; height:60px; object-fit:cover; border-radius:6px}
    .reference-preview-info{flex:1; display:flex; flex-direction:column; gap:4px}
    .reference-preview-label{font-size:12px; color:var(--muted)}
    .reference-preview-remove{background:var(--sunken); border:1px solid var(--ring); color:var(--muted); padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px}
    .reference-preview-remove:hover{color:var(--text); border-color:var(--line)}
    .generate-btn{background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); color:#081018; font-weight:700; border:none; border-radius:8px; padding:12px 24px; cursor:pointer; transition:all 0.2s; transform:translateY(-2px)}
    .generate-btn:hover{transform:translateY(-1px)}
    .generate-btn:disabled{opacity:0.6; cursor:not-allowed; transform:none}

    .upload-btn{background:var(--card); border:1px solid var(--ring); color:var(--text); padding:8px 16px; border-radius:8px; cursor:pointer; font-size:14px; transition:all 0.2s; display:inline-flex; align-items:center; gap:8px; margin-bottom:16px}
    .upload-btn:hover{background:var(--sunken); border-color:var(--line)}
    .upload-btn input{display:none}
    .reference-indicator{background:var(--btn-start); color:#081018; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:600; margin-bottom:16px; display:none}
    .remove-ref-btn{background:var(--sunken); border:1px solid var(--ring); color:var(--muted); padding:4px 8px; border-radius:6px; cursor:pointer; font-size:12px; margin-left:8px}
    .remove-ref-btn:hover{color:var(--text); border-color:var(--text)}

    /* MiniPlusMenu styles */
    .mini-plus-btn{width:40px; height:40px; border-radius:50%; background:var(--card); border:1px solid var(--ring); color:var(--text); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:20px; font-weight:300; transition:all 0.2s; margin-bottom:16px}
    .mini-plus-btn:hover{background:var(--sunken); border-color:var(--line); transform:scale(1.05)}
    .mini-plus-menu{position:relative; display:flex; justify-content:flex-start; padding-left:480px}
    .mini-plus-dropdown{position:absolute; top:-10%; left:250px; background:var(--card); border:1px solid var(--ring); border-radius:10px; padding:6px; min-width:180px; box-shadow:0 8px 32px rgba(0,0,0,0.3); z-index:1000; display:none}
    .mini-plus-dropdown.active{display:block}

    /* Generated Images Grid */
    .generated-images-section{margin-top:32px; padding:20px 40px; text-align:center}
    .generated-images-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:16px; margin-top:16px}
    .grid-image-item{position:relative; background:var(--card); border-radius:12px; overflow:hidden; border:1px solid var(--ring); transition:transform 0.2s ease, box-shadow 0.2s ease}
    .grid-image-item:hover{transform:translateY(-4px); box-shadow:0 8px 32px rgba(0,0,0,0.3)}
    .grid-image-item img{width:100%; height:150px; object-fit:cover; display:block}
    .image-overlay{position:absolute; bottom:0; left:0; right:0; background:linear-gradient(transparent,rgba(0,0,0,0.8)); padding:12px; color:white}
    .image-overlay p{margin:0 0 8px 0; font-size:12px; line-height:1.4}
    .image-overlay button{padding:4px 8px; font-size:10px; border:none; border-radius:4px; background:var(--btn-start); color:black; cursor:pointer; transition:background 0.2s ease}
    .image-overlay button:hover{background:var(--btn-end)}
    @media (max-width: 768px) {
      .generated-images-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:12px}
    }
    .mini-plus-item{padding:8px 12px; cursor:pointer; border-radius:8px; transition:all 0.2s; display:flex; align-items:center; gap:10px; color:var(--text); font-size:14px}
    .mini-plus-item:hover{background:var(--sunken)}
    .mini-plus-item-icon{width:18px; text-align:center; font-size:14px}
    .generated-image-grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:16px; margin-top:24px}
    .generated-image-item{background:var(--card); border:1px solid var(--ring); border-radius:12px; overflow:hidden; transition:all 0.2s}
    .generated-image-item:hover{border-color:var(--line)}
    .generated-image-item img{width:100%; height:150px; object-fit:cover}
    .generated-image-info{padding:12px}
    .generated-image-title{font-size:14px; font-weight:600; color:var(--text); margin-bottom:4px}
    .generated-image-date{font-size:12px; color:var(--muted)}

    .quick-actions{display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:12px; max-width:600px}
    .action-chip{background:var(--card); border:1px solid var(--ring); color:var(--text); padding:8px 16px; border-radius:20px; cursor:pointer; font-size:14px; transition:all 0.2s}
    .action-chip:hover{background:var(--sunken); border-color:var(--line)}

    .chat-section{flex:1; overflow-y:auto; padding:20px 0}
    .chat-messages{display:flex; flex-direction:column; gap:20px; padding:0 4px}
    .message{display:flex; max-width:90%}
    .message.user{margin-left:auto}
    .message.assistant{margin-right:auto}
    .message-content{background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:16px; max-width:100%}
    .message.user .message-content{background:var(--sunken)}
    .message-header{font-size:10px; text-transform:uppercase; letter-spacing:0.5px; color:var(--muted); margin-bottom:8px}
    .message-text{color:var(--text); white-space:pre-wrap; word-break:break-word; line-height:1.6}
    .message-image{max-width:min(400px, 100%); width:100%; height:auto; border-radius:8px; margin-top:12px; display:block}
    .message-actions{margin-top:12px; display:flex; gap:8px}
    .save-btn{background:var(--card); border:1px solid var(--ring); color:var(--text); padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px; transition:all 0.2s; display:inline-flex; align-items:center; gap:4px}
    .save-btn:hover{background:var(--sunken); border-color:var(--line)}
    .save-btn:disabled{opacity:0.6; cursor:not-allowed}

    .bottom-input{border-top:1px solid var(--ring); padding:16px 0; background:var(--bg-0)}
    .bottom-input .input-container{min-width:auto; margin-bottom:0}

    h1{margin:0 0 8px; font-size:28px; font-weight:800}
    .subtitle{color:var(--muted); margin-bottom:24px}

    .form-group{margin-bottom:20px}
    .label{display:block; margin-bottom:8px; font-weight:600; color:var(--text)}
    .input, .textarea{width:100%; padding:12px; border:1px solid var(--ring); border-radius:8px; background:var(--sunken); color:var(--text); font-family:inherit}
    .input:focus, .textarea:focus{outline:none; border-color:var(--line)}
    .textarea{min-height:120px; resize:vertical}

    .btn{display:inline-block; padding:12px 24px; background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); color:#081018; font-weight:700; border:none; border-radius:8px; cursor:pointer; text-decoration:none; transition:all 0.2s}
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{opacity:0.6; cursor:not-allowed; transform:none}

    .preview-area{width:100%; height:400px; background:var(--bg-0); border:2px dashed var(--ring); border-radius:8px; display:flex; align-items:center; justify-content:center; color:var(--muted)}


    .msg{padding:12px 16px; border-radius:8px; margin-bottom:16px; font-size:14px}
    .msg.success{background:#0f2b22; color:#bbf7d0; border:1px solid #14532d}
    .msg.error{background:#3b1a1a; color:#fecaca; border:1px solid #7f1d1d}
    .msg.info{background:#1e293b; color:#cbd5e1; border:1px solid #475569}

    /* Hide all built-in password reveal/clear buttons across browsers - Updated */
    input::-ms-reveal,
    input::-ms-clear,
    input::-webkit-credentials-auto-fill-button,
    input::-webkit-password-toggle-button,
    input::-webkit-textfield-decoration-container {
      display: none !important;
      visibility: hidden !important;
      width: 0 !important;
      height: 0 !important;
      opacity: 0 !important;
      position: absolute !important;
      left: -9999px !important;
      pointer-events: none !important;
      -webkit-appearance: none !important;
    }

    /* Extra iOS Safari coverage */
    input[type="password"] {
      -webkit-appearance: none !important;
      -webkit-text-security: disc !important;
    }

    /* Full Library Modal */
    .full-library-modal{position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); z-index:300; opacity:0; visibility:hidden; transition:all 0.3s ease; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(5px)}
    .full-library-modal.show{opacity:1; visibility:visible}
    .full-library-content{background:var(--card); border-radius:16px; width:95%; max-width:1200px; height:90vh; display:flex; flex-direction:column; border:1px solid var(--ring)}
    .full-library-header{display:flex; justify-content:space-between; align-items:center; padding:20px 24px; border-bottom:1px solid var(--ring)}
    .full-library-header h2{margin:0; font-size:24px; font-weight:700; color:var(--text)}
    .full-library-close{background:none; border:none; color:var(--muted); font-size:28px; cursor:pointer; padding:0; width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:8px; transition:all 0.2s}
    .full-library-close:hover{background:var(--sunken); color:var(--text)}
    .full-library-grid{flex:1; overflow-y:auto; padding:24px; display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:20px}
    .full-library-item{background:var(--sunken); border-radius:12px; overflow:hidden; border:1px solid var(--ring); transition:all 0.2s}
    .full-library-item:hover{border-color:var(--line); transform:translateY(-2px)}
    .full-library-item-image{width:100%; aspect-ratio:1; object-fit:cover; cursor:pointer}
    .full-library-item-info{padding:12px}
    .full-library-item-prompt{font-size:13px; color:var(--text); margin-bottom:8px; line-height:1.4; max-height:40px; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical}
    .full-library-item-meta{display:flex; justify-content:space-between; align-items:center; font-size:11px; color:var(--muted); margin-bottom:12px}
    .full-library-item-actions{display:flex; gap:8px}
    .full-library-item-btn{flex:1; padding:8px 12px; border-radius:6px; border:none; font-size:12px; font-weight:600; cursor:pointer; transition:all 0.2s}
    .full-library-item-btn.save{background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); color:#081018}
    .full-library-item-btn.save:hover{transform:translateY(-1px)}
    .full-library-item-btn.delete{background:var(--card); color:var(--muted); border:1px solid var(--ring)}
    .full-library-item-btn.delete:hover{background:#ef4444; color:white; border-color:#ef4444}
    .full-library-empty{text-align:center; padding:80px 20px; color:var(--muted)}
    .full-library-empty-icon{font-size:64px; margin-bottom:16px; opacity:0.3}
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <button id="sidebar-toggle" class="sidebar-toggle">☰</button>
      <a href="/" class="logo">
        <img src="/logo.png" alt="Mini Visionary Logo">
        Mini Visionary
      </a>
    </div>
    <nav class="nav">
      <a href="/static/guide.html">Guide</a>
      <a href="/static/gallery.html">Gallery</a>
      <a href="/static/library.html">Library</a>
      <span class="credits-display">Credits: <span id="user-credits">Loading...</span></span>
      <a href="/static/store.html">💎 Store</a>
      <a href="/static/wallet.html">💰 Wallet</a>
      <a href="/static/profile.html">🧑 Profile</a>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </nav>
  </div>

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <button id="new-chat-btn" class="new-chat-btn">+ New Session Chat</button>
    </div>
    <div class="sidebar-title" style="cursor:pointer; display:flex; justify-content:space-between; align-items:center" onclick="openFullLibrary()">
      <span>Mini Library</span>
      <span style="font-size:10px; opacity:0.7">View All →</span>
    </div>
    <div id="mini-library" class="mini-library"></div>
    <div class="sidebar-title">Your Chats</div>
    <div id="chat-sessions" class="chat-sessions"></div>
    <div class="sidebar-footer">
      <img src="/logo.png" alt="Mini Visionary Logo" class="sidebar-logo">
    </div>
  </div>

  <!-- Sidebar Overlay -->
  <div id="sidebar-overlay" class="sidebar-overlay"></div>

  <!-- Full Library Modal -->
  <div id="full-library-modal" class="full-library-modal">
    <div class="full-library-content">
      <div class="full-library-header">
        <h2>Mini Library</h2>
        <button class="full-library-close" onclick="closeFullLibrary()">✕</button>
      </div>
      <div id="full-library-grid" class="full-library-grid"></div>
    </div>
  </div>

  <!-- Hidden file inputs for reference upload -->
  <input type="file" id="main-reference-input" accept="image/*" style="display: none;">
  <input type="file" id="chat-reference-input" accept="image/*" style="display: none;">

  <div class="main-content">
    <!-- Welcome Section (shown when no chat history) -->
    <div id="welcome-section" class="welcome-section">
      <h1 class="welcome-title">Hey <span id="username-placeholder">Visionary</span>. Ready to bring your Vision to life?</h1>
      <script>
        // Render username immediately on first paint - zero flicker with multiple fallbacks
        (function() {
          // Try meta tag, bootstrap, localStorage, cookie in that order
          function getInitialUsername() {
            const meta = document.querySelector('meta[name="mv-username"]');
            if (meta && meta.content) return meta.content.trim();

            if (window.__BOOTSTRAP__ && window.__BOOTSTRAP__.username) {
              return window.__BOOTSTRAP__.username.trim();
            }

            try {
              const ls = localStorage.getItem("mv_username");
              if (ls) return ls.trim();
            } catch {}

            const match = document.cookie.match(/(?:^|;\s*)mv_username=([^;]*)/);
            if (match) return decodeURIComponent(match[1]).trim();

            return null;
          }

          function setCaches(username) {
            try { localStorage.setItem("mv_username", username); } catch {}
            document.cookie = "mv_username=" + encodeURIComponent(username) + "; path=/; max-age=15552000";
          }

          const user = getInitialUsername();
          if (user) {
            document.getElementById("username-placeholder").textContent = user;
          }

          // Background refresh from API
          fetch("/api/me", {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
            }
          })
            .then(r => r.ok ? r.json() : Promise.reject())
            .then(data => {
              if (data && data.ok && data.user && data.user.display_name) {
                const newName = data.user.display_name;
                document.getElementById("username-placeholder").textContent = newName;
                setCaches(newName);
              }
            })
            .catch(() => { /* keep cached */ });
        })();
      </script>
      <div class="input-container">
        <div id="main-reference-preview" class="reference-preview">
          <img id="main-reference-img" src="" alt="Reference">
          <div class="reference-preview-info">
            <span class="reference-preview-label">📷 Reference Image</span>
          </div>
          <button class="reference-preview-remove" onclick="removeReference()">Remove</button>
        </div>
        <div class="input-wrapper">
          <textarea id="main-input" class="main-textarea" placeholder="Describe your poster vision..." rows="1"></textarea>
          <button id="main-generate-btn" class="generate-btn">Generate</button>
        </div>
      </div>

      <!-- MiniPlusMenu placed right after input -->
      <div class="mini-plus-menu" id="main-plus-menu">
        <button class="mini-plus-btn" id="main-plus-btn">+</button>
        <div class="mini-plus-dropdown" id="main-plus-dropdown">
          <div class="mini-plus-item" id="add-reference-btn">
            <span class="mini-plus-item-icon">📎</span>
            <span>Add Reference Image</span>
          </div>
        </div>
      </div>

      <div class="reference-indicator" id="main-reference-indicator">
        📷 Reference image uploaded
        <button class="remove-ref-btn" id="main-remove-ref">Remove</button>
      </div>

      <div class="quick-actions">
        <button class="action-chip" data-prompt="Create a movie poster: ">Movie Poster</button>
        <button class="action-chip" data-prompt="Create a vintage poster: ">Vintage Style</button>
        <button class="action-chip" data-prompt="Create a horror poster: ">Horror Theme</button>
        <button class="action-chip" data-prompt="Create a minimalist poster: ">Minimalist</button>
        <button class="action-chip" data-prompt="Create an action poster: ">Action Style</button>
        <button class="action-chip" data-prompt="Create a comedy poster: ">Comedy Theme</button>
      </div>
    </div>

    <!-- Chat Section (shown when there's conversation history) -->
    <div id="chat-section" class="chat-section" style="display: none;">
      <div id="chat-messages" class="chat-messages"></div>
    </div>

    <!-- Bottom Input (always visible when in chat mode) -->
    <div id="bottom-input" class="bottom-input" style="display: none;">
      <div class="input-container">
        <textarea id="chat-input" class="chat-textarea" placeholder="Describe another poster idea..." rows="1"></textarea>
        <button id="chat-generate-btn" class="generate-btn">Generate</button>
      </div>
      <div class="reference-indicator" id="chat-reference-indicator">
        📷 Reference image uploaded
        <button class="remove-ref-btn" id="chat-remove-ref">Remove</button>
      </div>
    </div>

    <!-- Generated Images Grid -->
    <div id="generated-images-section" class="generated-images-section" style="margin-top: 32px;">
      <h3 style="margin-bottom: 16px; color: var(--text);">Recent Generations</h3>
      <div id="generated-images-grid" class="generated-images-grid"></div>
    </div>

  </div>

  <script>
    // Check authentication
    const token = localStorage.getItem('jwt_token');

    if (!token) {
      window.location.href = '/auth.html#login';
    } else {
      // Load cached credits only (username already rendered inline)
      try {
        const cachedUser = localStorage.getItem('cached_user_data');
        if (cachedUser) {
          const userData = JSON.parse(cachedUser);
          const userCreditsEl = document.getElementById('user-credits');
          if (userCreditsEl && userData.credits !== undefined) {
            userCreditsEl.textContent = userData.credits;
          }
        }
      } catch (e) {
        // Error loading cached data
      }

      // Load user info - only logout on actual auth failures (401), not network issues
      fetch('/api/me', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(r => {
        // Only logout on 401 Unauthorized - ignore other errors
        if (r.status === 401) {
          logout();
          return null;
        }
        if (!r.ok) {
          return null;
        }
        return r.json();
      })
      .then(data => {
        if (!data) return; // Skip if we already handled error above

        if (data.ok) {
          // Store user ID globally for user-specific data
          window.currentUserId = data.user.id;
          window.currentUserEmail = data.user.email;

          // Safely update DOM elements if they exist
          const userCreditsEl = document.getElementById('user-credits');

          if (userCreditsEl) userCreditsEl.textContent = data.credits || 0;
          // username-placeholder is already updated by inline script

          // Update cached credits to prevent flash on next refresh
          try {
            const cachedData = JSON.parse(localStorage.getItem('cached_user_data') || '{}');
            cachedData.credits = data.user.credits;
            localStorage.setItem('cached_user_data', JSON.stringify(cachedData));
          } catch (e) {
            // Error updating cached credits
          }

          // Load user-specific Mini Library
          loadMiniLibraryForUser();

          // Load user-specific sessions
          currentUserId = data.user.id || data.user.user_id;

          // FORCE WIPE: Remove ALL old mv_ keys that aren't user-specific
          const allKeys = Object.keys(localStorage);
          allKeys.forEach(key => {
            if (key.startsWith('mv_') &&
                !key.includes(`_${currentUserId}_`) &&
                !key.includes(`_${currentUserId}`) &&
                key !== 'jwt_token' &&
                key !== 'cached_user_data') {
              localStorage.removeItem(key);
            }
          });

          if (currentUserId) {
            sessions = JSON.parse(localStorage.getItem(`mv_sessions_${currentUserId}`) || '[]');
            activeSessionId = localStorage.getItem(`mv_current_session_${currentUserId}`);
          }

          // Initialize sessions now that we have currentUserId
          initSessions();
        }
      })
      .catch(err => {
        // Network errors, timeouts, etc - don't logout
        // Still init sessions even on error (will create new session)
        initSessions();
      });
    }

    // Navigation function
    function navigateTo(page) {
      // For now, show a message that these pages are coming soon
      switch(page) {
        case 'guide':
          addMessage('assistant', '📚 Guide page is coming soon! For now, you can use the quick action chips below to get started.');
          break;
        case 'gallery':
          addMessage('assistant', '🇺️ Gallery page is coming soon! Your generated images appear in the "Recent Generations" section below.');
          break;
        case 'library':
          addMessage('assistant', '📁 Library page is coming soon! You can access your saved images through the + menu > "From Library".');
          break;
        case 'store':
          addMessage('assistant', '💎 Store page is coming soon! Stay tuned for credit packages and premium features.');
          break;
        case 'wallet':
          addMessage('assistant', '💰 Wallet page is coming soon! Your current credits are shown in the header.');
          break;
        case 'profile':
          addMessage('assistant', '🧑 Profile page is coming soon! You can logout using the button in the top right.');
          break;
        default:
          addMessage('assistant', '⚠️ Page not found.');
      }
    }

    // Logout function
    function logout() {
      // Clear all user-specific data
      localStorage.clear();
      sessionStorage.clear();

      // Clear cookies
      document.cookie.split(";").forEach(function(c) {
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
      });

      window.location.href = '/auth.html#login';
    }

    // Show message
    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.className = `msg ${type}`;
      msg.textContent = text;
      msg.style.display = 'block';
    }

    // Hide message
    function hideMessage() {
      document.getElementById('message').style.display = 'none';
    }

    // Multi-session chat state
    let sessions = [];
    let activeSessionId = null;
    let chatHistory = [];
    let isGenerating = false;
    let currentUserId = null;

    // Helper function to save sessions with user-specific key
    function saveSessions() {
      if (currentUserId) {
        localStorage.setItem(`mv_sessions_${currentUserId}`, JSON.stringify(sessions));
      }
    }

    // Helper function to save current session ID
    function saveCurrentSession() {
      if (currentUserId && activeSessionId) {
        localStorage.setItem(`mv_current_session_${currentUserId}`, activeSessionId);
      }
    }

    // Session management
    function generateSessionId() {
      return crypto.randomUUID();
    }


    function setActiveSession(sessionId) {
      activeSessionId = sessionId;
      chatHistory = currentUserId ? JSON.parse(localStorage.getItem(`mv_chat_${currentUserId}_${sessionId}`) || '[]') : [];

      if (chatHistory.length > 0) {
        showChatMode();
        renderChatHistory();
      } else {
        showWelcomeMode();
      }
    }

    function updateSessionTitle(sessionId, title) {
      const session = sessions.find(s => s.id === sessionId);
      if (session && !session.titleChanged) {
        session.title = title;
        session.titleChanged = true;
        session.updatedAt = new Date().toISOString();
        saveSessions();
        renderSessions();
      }
    }

    function deleteSession(sessionId) {
      if (sessions.length <= 1) return; // Keep at least one session

      sessions = sessions.filter(s => s.id !== sessionId);
      saveSessions();
      localStorage.removeItem(`mv_chat_${sessionId}`);

      if (activeSessionId === sessionId) {
        setActiveSession(sessions[0].id);
      }
      renderSessions();
    }

    function renameSession(sessionId) {
      const session = sessions.find(s => s.id === sessionId);
      if (!session) return;

      const newTitle = prompt('Rename chat', session.title);
      if (newTitle && newTitle.trim()) {
        session.title = newTitle.trim();
        session.titleChanged = true;
        session.updatedAt = new Date().toISOString();
        saveSessions();
        renderSessions();
      }
    }

    function renderSessions() {
      const container = document.getElementById('chat-sessions');
      container.innerHTML = sessions.map(session => `
        <div class="chat-session ${session.id === activeSessionId ? 'active' : ''}" data-session-id="${session.id}">
          <div class="chat-session-title">${session.title}</div>
          <div class="chat-session-actions">
            <button class="session-btn" onclick="renameSession('${session.id}')" title="Rename">✏️</button>
            <button class="session-btn" onclick="deleteSession('${session.id}')" title="Delete">🗑️</button>
          </div>
        </div>
      `).join('');

      // Add click listeners to session items
      document.querySelectorAll('.chat-session').forEach(item => {
        item.addEventListener('click', (e) => {
          if (!e.target.closest('.chat-session-actions')) {
            const sessionId = item.dataset.sessionId;
            setActiveSession(sessionId);
            renderSessions();
          }
        });
      });
    }

    // Sidebar functionality
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');

      sidebar.classList.toggle('open');
      overlay.classList.toggle('show');
    }

    function closeSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');

      sidebar.classList.remove('open');
      overlay.classList.remove('show');
    }

    // Initialize interface
    function initInterface() {
      if (chatHistory.length > 0) {
        showChatMode();
        renderChatHistory();
      } else {
        showWelcomeMode();
      }
    }

    function showWelcomeMode() {
      document.getElementById('welcome-section').style.display = 'flex';
      document.getElementById('chat-section').style.display = 'none';
      document.getElementById('bottom-input').style.display = 'none';
    }

    function showChatMode() {
      document.getElementById('welcome-section').style.display = 'none';
      document.getElementById('chat-section').style.display = 'flex';
      document.getElementById('bottom-input').style.display = 'block';
    }

    function addMessage(role, content, imageUrl = null) {
      const message = {
        id: crypto.randomUUID(),
        role,
        content,
        imageUrl,
        timestamp: new Date().toISOString()
      };
      chatHistory.push(message);
      localStorage.setItem('mv_chat', JSON.stringify(chatHistory));

      if (chatHistory.length === 1) {
        showChatMode();
      }
      renderChatHistory();
      scrollToBottom();
    }

    function renderChatHistory() {
      const container = document.getElementById('chat-messages');
      container.innerHTML = chatHistory.map((msg, index) => `
        <div class="message ${msg.role}">
          <div class="message-content">
            <div class="message-header">${msg.role === 'user' ? 'You' : 'Mini Visionary'} · ${new Date(msg.timestamp).toLocaleTimeString()}</div>
            <div class="message-text">${msg.content}</div>
            ${msg.imageUrl ? `<img src="${msg.imageUrl}" alt="Generated poster" class="message-image" onerror="this.style.display='none'; this.parentElement.querySelector('.save-btn')?.remove();">` : ''}
            ${msg.imageUrl ? `<div class="message-actions"><button class="save-btn" onclick="saveToLibrary('${msg.imageUrl}', ${index})">💾 Save to Library</button></div>` : ''}
          </div>
        </div>
      `).join('');
    }

    function scrollToBottom() {
      const container = document.getElementById('chat-messages');
      container.scrollTop = container.scrollHeight;
    }

    async function generatePoster(prompt) {
      if (!prompt.trim() || isGenerating) return;

      addMessage('user', prompt);
      isGenerating = true;

      // Update button states
      const buttons = document.querySelectorAll('.generate-btn');
      buttons.forEach(btn => {
        btn.disabled = true;
        btn.textContent = 'Generating...';
      });

      try {
        // Get user ID from cached data
        let userId = null;
        try {
          const cached = localStorage.getItem('cached_user_data');
          if (cached) {
            const userData = JSON.parse(cached);
            userId = userData.id || userData.user_id || userData.username;
          }
        } catch (e) {}

        const response = await fetch('/api/poster/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            prompt,
            size: '1024x1024',
            quality: 'standard',
            n: 1,
            user_id: userId
          })
        });

        const data = await response.json();

        if (data.ok && data.image_b64_png) {
          // Convert base64 to data URL
          const imageUrl = `data:image/png;base64,${data.image_b64_png}`;

          // Update credits display
          const creditsEl = document.getElementById('user-credits');
          if (creditsEl) creditsEl.textContent = data.credits || 0;

          let message = '✨ Here\'s your generated image!';
          message += `\n\n💎 Credits remaining: ${data.credits || 0}`;

          addMessage('assistant', message, imageUrl);
          addToImageGrid(imageUrl, prompt, data.job_id);
          addToMiniLibrary(imageUrl, prompt, data.job_id);
        } else {
          addMessage('assistant', `⚠️ ${data.error || 'Failed to generate image'}`);
        }
      } catch (error) {
        addMessage('assistant', `⚠️ Network error: ${error.message}`);
      } finally {
        isGenerating = false;
        buttons.forEach(btn => {
          btn.disabled = false;
          btn.textContent = 'Generate';
        });

        // Clear inputs
        const mainInput = document.getElementById('main-input');
        const chatInput = document.getElementById('chat-input');
        if (mainInput) mainInput.value = '';
        if (chatInput) chatInput.value = '';
      }
    }

    // Event listeners
    const mainBtn = document.getElementById('main-generate-btn');
    const chatBtn = document.getElementById('chat-generate-btn');

    if (mainBtn) {
      mainBtn.addEventListener('click', () => {
        const prompt = document.getElementById('main-input').value.trim();
        if (prompt) generatePoster(prompt);
      });
    }

    if (chatBtn) {
      chatBtn.addEventListener('click', () => {
        const prompt = document.getElementById('chat-input').value.trim();
        if (prompt) generatePoster(prompt);
      });
    }

    // Enter key handling
    function handleEnterKey(e, inputId) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const prompt = document.getElementById(inputId).value.trim();
        if (prompt) generatePoster(prompt);
      }
    }

    const mainInput = document.getElementById('main-input');
    const chatInput = document.getElementById('chat-input');

    if (mainInput) mainInput.addEventListener('keydown', (e) => handleEnterKey(e, 'main-input'));
    if (chatInput) chatInput.addEventListener('keydown', (e) => handleEnterKey(e, 'chat-input'));

    // Quick action chips
    document.querySelectorAll('.action-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const prompt = chip.dataset.prompt;
        const mainInput = document.getElementById('main-input');
        if (mainInput) {
          mainInput.value = prompt;
          mainInput.focus();
        }
      });
    });

    // Multi-session management (using existing variables from line 326)

    function generateSessionId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function createNewSession() {
      // First, ensure current session is saved and updated
      if (activeSessionId && chatHistory.length > 0) {
        // Save current chat history
        if (currentUserId) localStorage.setItem(`mv_chat_${currentUserId}_${activeSessionId}`, JSON.stringify(chatHistory));

        // Update current session title if it hasn't been changed and has messages
        updateSessionTitle(activeSessionId);

        // Update current session's updatedAt timestamp
        const currentSession = sessions.find(s => s.id === activeSessionId);
        if (currentSession) {
          currentSession.updatedAt = new Date().toISOString();
        }
      }

      // Create new session
      const sessionId = generateSessionId();
      const session = {
        id: sessionId,
        title: 'Session Chat',
        titleChanged: false,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      // Add new session to the beginning of the list
      sessions.unshift(session);
      saveSessions();

      // Switch to new session (this will clear chatHistory and show welcome screen)
      switchToSession(sessionId);
      renderSessions();

      // Clear reference image for new session
      removeReference();
    }

    function switchToSession(sessionId) {
      // Save current chat history and images to session-specific storage
      if (activeSessionId && chatHistory.length > 0) {
        if (currentUserId) localStorage.setItem(`mv_chat_${currentUserId}_${activeSessionId}`, JSON.stringify(chatHistory));
        if (currentUserId) localStorage.setItem(`mv_images_${currentUserId}_${activeSessionId}`, JSON.stringify(generatedImages));
      }

      activeSessionId = sessionId;
      saveCurrentSession();

      // Load chat history and images for this session
      chatHistory = currentUserId ? JSON.parse(localStorage.getItem(`mv_chat_${currentUserId}_${sessionId}`) || '[]') : [];
      generatedImages = currentUserId ? JSON.parse(localStorage.getItem(`mv_images_${currentUserId}_${sessionId}`) || '[]') : [];

      if (chatHistory.length === 0) {
        showWelcomeMode();
      } else {
        showChatMode();
      }

      renderChatHistory();
      updateImageGrid();
      renderSessions();
    }

    function deleteSession(sessionId) {
      if (sessions.length <= 1) return; // Keep at least one session

      sessions = sessions.filter(s => s.id !== sessionId);
      saveSessions();
      if (currentUserId) localStorage.removeItem(`mv_chat_${currentUserId}_${sessionId}`);
      if (currentUserId) localStorage.removeItem(`mv_images_${currentUserId}_${sessionId}`); // Clear images for this session

      if (activeSessionId === sessionId) {
        switchToSession(sessions[0].id);
      }

      renderSessions();
    }

    function renameSession(sessionId, newTitle) {
      const session = sessions.find(s => s.id === sessionId);
      if (session) {
        session.title = newTitle.trim() || 'Untitled';
        session.titleChanged = true;
        session.updatedAt = new Date().toISOString();
        saveSessions();
        renderSessions();
      }
    }

    function updateSessionTitle(sessionId) {
      const session = sessions.find(s => s.id === sessionId);
      const sessionMessages = currentUserId ? JSON.parse(localStorage.getItem(`mv_chat_${currentUserId}_${sessionId}`) || '[]') : [];

      if (session && !session.titleChanged && sessionMessages.length > 0) {
        const firstUserMessage = sessionMessages.find(m => m.role === 'user');
        if (firstUserMessage) {
          // Create a clean title from the first prompt
          let title = firstUserMessage.content.trim();
          // Remove common prefixes
          title = title.replace(/^(create|generate|make|draw|design)\s+/i, '');
          // Capitalize first letter
          title = title.charAt(0).toUpperCase() + title.slice(1);
          // Truncate to 40 characters for better readability
          session.title = title.slice(0, 40) + (title.length > 40 ? '...' : '');
          session.updatedAt = new Date().toISOString();
          saveSessions();
        }
      }
    }

    function renderSessions() {
      const container = document.getElementById('chat-sessions');
      container.innerHTML = sessions.map(session => `
        <div class="session-item ${session.id === activeSessionId ? 'active' : ''}" data-session-id="${session.id}">
          <div class="session-content" onclick="switchToSession('${session.id}')">
            <div class="session-title">${session.title}</div>
            <div class="session-date">${new Date(session.updatedAt).toLocaleDateString()}</div>
          </div>
          <div class="session-actions">
            <button class="session-action" onclick="event.stopPropagation(); promptRename('${session.id}')" title="Rename">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="m18.5 2.5-8 8v4h4l8-8a2 2 0 0 0 0-2.83z"></path>
              </svg>
            </button>
            <button class="session-action delete" onclick="event.stopPropagation(); deleteSession('${session.id}')" title="Delete" ${sessions.length <= 1 ? 'disabled' : ''}>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3,6 5,6 21,6"></polyline>
                <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
              </svg>
            </button>
          </div>
        </div>
      `).join('');
    }

    function promptRename(sessionId) {
      const session = sessions.find(s => s.id === sessionId);
      if (session) {
        const newTitle = prompt('Enter new chat name:', session.title);
        if (newTitle !== null) {
          renameSession(sessionId, newTitle);
        }
      }
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      const isOpen = sidebar.classList.contains('open');

      if (isOpen) {
        sidebar.classList.remove('open');
        overlay.classList.remove('show');
      } else {
        sidebar.classList.add('open');
        overlay.classList.add('show');
      }
    }

    // Override addMessage to update session title
    const originalAddMessage = addMessage;
    addMessage = function(role, content, imageUrl) {
      originalAddMessage(role, content, imageUrl);

      if (activeSessionId && role === 'user') {
        updateSessionTitle(activeSessionId);
        renderSessions();
      }

      // Save to session-specific storage
      if (activeSessionId) {
        if (currentUserId) localStorage.setItem(`mv_chat_${currentUserId}_${activeSessionId}`, JSON.stringify(chatHistory));
      }
    };

    // OLD GHOST CODE ARCHIVED - no more localStorage migrations

    // Initialize sessions
    function initSessions() {
      if (sessions.length === 0) {
        createNewSession();
      } else {
        if (!activeSessionId || !sessions.find(s => s.id === activeSessionId)) {
          activeSessionId = sessions[0].id;
          saveCurrentSession();
        }
        switchToSession(activeSessionId);
      }
      renderSessions();
    }

    // Reference image upload functionality
    let referenceImage = null;

    // Client-side image compression to avoid 413 errors
    async function compressImage(file, maxSize = 1024, quality = 0.85) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            // Create canvas
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // Calculate new dimensions (max 1024px)
            if (width > maxSize || height > maxSize) {
              if (width > height) {
                height = (height / width) * maxSize;
                width = maxSize;
              } else {
                width = (width / height) * maxSize;
                height = maxSize;
              }
            }

            canvas.width = width;
            canvas.height = height;

            // Draw and compress
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // Convert to blob with quality compression
            canvas.toBlob((blob) => {
              if (blob) {
                // Create new File object with compressed blob
                const compressedFile = new File([blob], file.name, {
                  type: 'image/png',
                  lastModified: Date.now()
                });
                resolve(compressedFile);
              } else {
                reject(new Error('Compression failed'));
              }
            }, 'image/png', quality);
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function setupReferenceUpload() {
      // Main reference input (hidden file input)
      const mainFileInput = document.getElementById('main-reference-input');
      const mainIndicator = document.getElementById('main-reference-indicator');
      const mainRemoveBtn = document.getElementById('main-remove-ref');

      // Chat reference input (hidden file input)
      const chatFileInput = document.getElementById('chat-reference-input');
      const chatIndicator = document.getElementById('chat-reference-indicator');
      const chatRemoveBtn = document.getElementById('chat-remove-ref');

      // Setup main upload if elements exist
      if (mainFileInput) {
        mainFileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) handleImageUpload(file);
        });
      }

      if (mainRemoveBtn) {
        mainRemoveBtn.addEventListener('click', removeReference);
      }

      // Setup chat upload if elements exist
      if (chatFileInput) {
        chatFileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) handleImageUpload(file);
        });
      }

      if (chatRemoveBtn) {
        chatRemoveBtn.addEventListener('click', removeReference);
      }
    }

    function handleImageUpload(file) {
      // Store the original File object (not data URL)
      referenceImage = file;

      // Create preview
      const reader = new FileReader();
      reader.onload = (e) => {
        // Update preview image
        const previewImg = document.getElementById('main-reference-img');
        if (previewImg) {
          previewImg.src = e.target.result;
        }

        // Show preview in input container
        const preview = document.getElementById('main-reference-preview');
        if (preview) {
          preview.style.display = 'flex';
        }

        updateReferenceIndicators(true);
      };
      reader.readAsDataURL(file);
    }

    function removeReference() {
      referenceImage = null;

      // Hide preview
      const preview = document.getElementById('main-reference-preview');
      if (preview) {
        preview.style.display = 'none';
      }

      updateReferenceIndicators(false);
      const mainInput = document.getElementById('main-reference-input');
      const chatInput = document.getElementById('chat-reference-input');
      if (mainInput) mainInput.value = '';
      if (chatInput) chatInput.value = '';
    }

    function updateReferenceIndicators(show) {
      const mainIndicator = document.getElementById('main-reference-indicator');
      const chatIndicator = document.getElementById('chat-reference-indicator');

      if (show) {
        if (mainIndicator) mainIndicator.style.display = 'block';
        if (chatIndicator) chatIndicator.style.display = 'block';
      } else {
        if (mainIndicator) mainIndicator.style.display = 'none';
        if (chatIndicator) chatIndicator.style.display = 'none';
      }
    }

    // Update generatePoster function to include reference image
    const originalGeneratePoster = generatePoster;
    generatePoster = async function(prompt) {
      if (!prompt.trim() || isGenerating) return;

      addMessage('user', prompt);
      isGenerating = true;

      // Update button states
      const buttons = document.querySelectorAll('.generate-btn');
      buttons.forEach(btn => {
        btn.disabled = true;
        btn.textContent = 'Generating...';
      });

      try {
        // Get user ID from cached data
        let userId = null;
        try {
          const cached = localStorage.getItem('cached_user_data');
          if (cached) {
            const userData = JSON.parse(cached);
            userId = userData.id || userData.user_id || userData.username;
          }
        } catch (e) {}

        let response, data;

        // Smart routing based on reference image and prompt
        if (referenceImage) {
          // Compress image on client-side before upload to avoid 413 errors
          const compressedImage = await compressImage(referenceImage, 1024, 0.85);

          const formData = new FormData();
          formData.append('image', compressedImage, 'reference.png');
          formData.append('size', '1024x1024');
          if (userId) formData.append('user_id', userId);

          // Determine which endpoint to use based on prompt
          const lowerPrompt = prompt.toLowerCase();
          let endpoint = '/api/poster/remix'; // Default to remix for transformations
          let mode = 'remix';

          // Check if user wants variations (similar images without transformation)
          if (lowerPrompt.includes('variation') || lowerPrompt.includes('similar') ||
              lowerPrompt === 'more' || lowerPrompt === 'another') {
            endpoint = '/api/poster/variations';
            mode = 'variations';
            // Variations don't need a prompt
          } else if (lowerPrompt.includes('inpaint') || lowerPrompt.includes('fill') ||
                     lowerPrompt.includes('transparent') || lowerPrompt.includes('background only')) {
            // User explicitly wants inpainting
            endpoint = '/api/poster/edit';
            mode = 'edit';
            formData.append('prompt', prompt);
            formData.append('n', '1');
          } else {
            // Default: style transformation with remix
            formData.append('prompt', prompt);
            formData.append('n', '1');
          }

          response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            },
            body: formData
          });
        } else {
          // No reference - use DALL-E 3 generate endpoint
          response = await fetch('/api/poster/generate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              prompt,
              size: '1024x1024',
              quality: 'standard',
              n: 1,
              user_id: userId
            })
          });
        }

        // Handle non-OK responses
        if (!response.ok) {
          let errorMsg = `Server error (${response.status})`;
          let suggestion = '';

          // Clone response before reading so we can try both JSON and text
          const responseClone = response.clone();

          try {
            data = await response.json();
            errorMsg = data.error || errorMsg;
            if (data.details) errorMsg += `\n\n${data.details}`;
            if (data.suggestion) suggestion = `\n\n💡 ${data.suggestion}`;
          } catch (e) {
            // Response wasn't JSON, read as text from clone
            try {
              const text = await responseClone.text();
              if (text) errorMsg += `\n\n${text.substring(0, 200)}`;
            } catch (textErr) {
              // Ignore - just use status code
            }
          }

          if (referenceImage && !suggestion) {
            suggestion = '\n\n💡 Tip: Try a smaller/simpler reference image, or generate without reference.';
          }

          addMessage('assistant', `⚠️ ${errorMsg}${suggestion}`);
          return;
        }

        data = await response.json();

        if (data.ok && data.items && data.items.length > 0) {
          const imageUrl = data.items[0].url;

          // Show model and mode used
          let message = '';
          if (data.mode === 'remix') {
            message = '🎨 Remix complete! Transformed your image with DALL-E 3';
            if (data.original_description) {
              // Show full description with better formatting
              const desc = data.original_description;
              if (desc.length > 200) {
                message += `\n\n🔍 Vision analysis:\n${desc.substring(0, 200)}... [+${desc.length - 200} chars]`;
              } else {
                message += `\n\n🔍 Vision analysis: ${desc}`;
              }
            } else if (data.vision_unavailable) {
              message += '\n\n⚠️ Vision analysis unavailable - used your prompt directly';
            }
          } else if (data.mode === 'variations') {
            message = '✨ Variations created! (DALL-E 2)';
          } else if (data.mode === 'edit/inpaint') {
            message = '🖌️ Inpainting complete! Filled transparent areas (DALL-E 2)';
          } else if (referenceImage) {
            message = '✨ Reference-based generation complete!';
          } else {
            message = '✨ Here\'s your generated poster! (DALL-E 3)';
          }

          if (data.enhanced_prompt && data.enhanced_prompt !== prompt && data.mode !== 'remix') {
            message += `\n\n🔮 Enhanced: ${data.enhanced_prompt}`;
          }

          addMessage('assistant', message, imageUrl);
          addToImageGrid(imageUrl, prompt);
        } else {
          const errorMsg = data.error || 'Failed to generate poster';
          const details = data.details ? `\n\n${data.details}` : '';
          addMessage('assistant', `⚠️ ${errorMsg}${details}`);
        }
      } catch (error) {
        addMessage('assistant', `⚠️ Network error: ${error.message}`);
      } finally {
        isGenerating = false;
        buttons.forEach(btn => {
          btn.disabled = false;
          btn.textContent = 'Generate';
        });

        // Clear inputs
        const mainInput = document.getElementById('main-input');
        const chatInput = document.getElementById('chat-input');
        if (mainInput) mainInput.value = '';
        if (chatInput) chatInput.value = '';
      }
    };

    // OLD GHOST CODE ARCHIVED - saveToLibrary used old localStorage

    // Event listeners for sidebar
    document.getElementById('new-chat-btn').addEventListener('click', createNewSession);
    document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);
    document.getElementById('sidebar-overlay').addEventListener('click', toggleSidebar);

    // MiniPlusMenu functionality
    let generatedImages = [];
    let miniLibrary = [];

    // Load user-specific Mini Library from PostgreSQL
    async function loadMiniLibraryForUser() {
      if (!token) return;

      // Always clear library first
      miniLibrary = [];

      try {
        const response = await fetch('/api/library?collection=mini_library', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          renderMiniLibrary();
          return;
        }

        const data = await response.json();
        if (data.ok && data.items) {
          // Load images for each library item
          for (const item of data.items) {
            const imgResponse = await fetch(`/api/history/${item.image_job_id}/png`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });

            if (imgResponse.ok) {
              const blob = await imgResponse.blob();
              const imageUrl = URL.createObjectURL(blob);

              miniLibrary.push({
                id: item.id,
                image_job_id: item.image_job_id,
                url: imageUrl,
                prompt: item.prompt,
                timestamp: item.created_at
              });
            }
          }

          renderMiniLibrary();
        } else {
          renderMiniLibrary();
        }
      } catch (error) {
        renderMiniLibrary();
      }
    }

    function initMiniPlusMenu() {
      const plusBtn = document.getElementById('main-plus-btn');
      const dropdown = document.getElementById('main-plus-dropdown');

      if (plusBtn && dropdown) {
        // Remove any existing listeners
        plusBtn.removeEventListener('click', handlePlusClick);

        // Add click listener
        plusBtn.addEventListener('click', handlePlusClick);

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.mini-plus-menu')) {
            dropdown.classList.remove('active');
          }
        });

        // Menu item handlers
        document.getElementById('add-reference-btn')?.addEventListener('click', openAddReference);
      }
    }

    function handlePlusClick(e) {
      e.stopPropagation();
      const dropdown = document.getElementById('main-plus-dropdown');
      if (dropdown) {
        dropdown.classList.toggle('active');
      }
    }

    function openFromLibrary() {
      // Close dropdown
      document.querySelector('.mini-plus-dropdown').classList.remove('active');

      // Fetch user's library images
      fetch('/api/library', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.ok && data.images) {
          showLibraryModal(data.images);
        } else {
          addMessage('assistant', '📚 Your library is empty. Generate some posters first!');
        }
      })
      .catch(error => {
        addMessage('assistant', '⚠️ Failed to load library');
      });
    }

    function openTemplates() {
      document.querySelector('.mini-plus-dropdown').classList.remove('active');

      const templates = [
        'Vintage poster style',
        'Modern minimalist design',
        'Retro 80s aesthetic',
        'Abstract art style',
        'Movie poster layout',
        'Concert poster design',
        'Event announcement style',
        'Typography-focused poster'
      ];

      showTemplatesModal(templates);
    }

    function openUploadDialog() {
      document.querySelector('.mini-plus-dropdown').classList.remove('active');

      // Trigger the existing reference upload
      const fileInput = document.getElementById('reference-upload');
      if (fileInput) {
        fileInput.click();
      }
    }

    function openAddReference() {
      document.querySelector('.mini-plus-dropdown').classList.remove('active');

      // Trigger the main reference upload
      const fileInput = document.getElementById('main-reference-input');
      if (fileInput) {
        fileInput.click();
      }
    }

    function openTextPrompts() {
      document.querySelector('.mini-plus-dropdown').classList.remove('active');

      const prompts = [
        'Create a poster for a jazz festival',
        'Design a movie poster for a sci-fi thriller',
        'Make a vintage travel poster for Paris',
        'Create a minimalist concert poster',
        'Design a poster for a food festival',
        'Make a retro gaming tournament poster',
        'Create an art exhibition announcement',
        'Design a motivational quote poster'
      ];

      showTextPromptsModal(prompts);
    }

    function showLibraryModal(images) {
      const modal = createModal('Your Library',
        images.map(img => `
          <div class="library-item" onclick="useLibraryImage('${img.url}', '${img.prompt}')">
            <img src="${img.url}" alt="${img.prompt}" style="width:100px;height:100px;object-fit:cover;border-radius:8px;">
            <p style="font-size:12px;margin:4px 0;">${img.prompt}</p>
          </div>
        `).join('')
      );

      document.body.appendChild(modal);
    }

    function showTemplatesModal(templates) {
      const modal = createModal('Choose Template',
        templates.map(template => `
          <div class="template-item" onclick="useTemplate('${template}')">
            <p>${template}</p>
          </div>
        `).join('')
      );

      document.body.appendChild(modal);
    }

    function showTextPromptsModal(prompts) {
      const modal = createModal('Quick Prompts',
        prompts.map(prompt => `
          <div class="prompt-item" onclick="usePrompt('${prompt}')">
            <p>${prompt}</p>
          </div>
        `).join('')
      );

      document.body.appendChild(modal);
    }

    function createModal(title, content) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>${title}</h3>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
          </div>
          <div class="modal-body" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px;max-height:400px;overflow-y:auto;">
            ${content}
          </div>
        </div>
      `;

      // Add modal styles
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
      `;

      const modalContent = modal.querySelector('.modal-content');
      modalContent.style.cssText = `
        background: var(--card); border-radius: 16px; padding: 24px;
        max-width: 600px; width: 90%; max-height: 80vh;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      `;

      return modal;
    }

    function useLibraryImage(url, prompt) {
      document.querySelector('.modal-overlay').remove();
      referenceImage = url;
      updateReferenceIndicators(true);
      addMessage('assistant', `📚 Using library image as reference: "${prompt}"`);
    }

    function useTemplate(template) {
      document.querySelector('.modal-overlay').remove();
      const input = document.getElementById('main-input') || document.getElementById('chat-input');
      if (input) {
        input.value = template;
        input.focus();
      }
      addMessage('assistant', `🎨 Template selected: "${template}"`);
    }

    function usePrompt(prompt) {
      document.querySelector('.modal-overlay').remove();
      const input = document.getElementById('main-input') || document.getElementById('chat-input');
      if (input) {
        input.value = prompt;
        input.focus();
      }
      addMessage('assistant', `💭 Prompt selected: "${prompt}"`);
    }

    // Add generated images to the grid
    function addToImageGrid(imageUrl, prompt, jobId) {
      generatedImages.unshift({
        id: jobId || Date.now(),
        image_job_id: jobId,
        url: imageUrl,
        prompt: prompt,
        timestamp: new Date().toISOString()
      });

      // Keep only last 20 images
      if (generatedImages.length > 20) {
        generatedImages = generatedImages.slice(0, 20);
      }

      // Save to session-specific localStorage (temporary, for this session only)
      if (currentUserId) localStorage.setItem(`mv_images_${currentUserId}_${activeSessionId}`, JSON.stringify(generatedImages));
      updateImageGrid();
    }

    function updateImageGrid() {
      const gridContainer = document.getElementById('generated-images-grid');
      if (!gridContainer) return;

      gridContainer.innerHTML = generatedImages.map(img => `
        <div class="grid-image-item" style="position:relative;">
          <img src="${img.url}" alt="${img.prompt}" style="width:100%;height:150px;object-fit:cover;border-radius:8px;" onerror="this.parentElement.remove();">
          <div class="image-overlay" style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,0.7));padding:8px;border-radius:0 0 8px 8px;">
            <p style="font-size:12px;color:white;margin:0;">${img.prompt}</p>
            <button onclick="saveToLibrary('${img.url}', 0)" style="margin-top:4px;padding:4px 8px;font-size:10px;border:none;border-radius:4px;background:var(--btn-start);color:black;">Save</button>
          </div>
        </div>
      `).join('');
    }

    // Images are now loaded per-session in switchToSession()

    // Mini Library Functions - images auto-saved to PostgreSQL on backend
    // This just updates the frontend display after generation
    async function addToMiniLibrary(imageUrl, prompt, jobId) {
      // The image is already saved to PostgreSQL via the backend
      // Reload the library to get the correct library.id
      await loadMiniLibraryForUser();
    }

    function renderMiniLibrary() {
      const container = document.getElementById('mini-library');
      if (!container) return;

      if (miniLibrary.length === 0) {
        container.innerHTML = '<div class="library-count">No images yet</div>';
        return;
      }

      // Privacy mode - only show count, no thumbnails
      container.innerHTML = `
        <div class="library-count" style="padding: 20px 12px; text-align: center;">
          <div style="font-size: 32px; margin-bottom: 8px;">📚</div>
          <div style="font-size: 16px; font-weight: 600; color: var(--text);">${miniLibrary.length} image${miniLibrary.length !== 1 ? 's' : ''}</div>
          <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">Click "View All" to see</div>
        </div>
      `;
    }

    function viewLibraryImage(url, prompt) {
      addMessage('assistant', `📚 From Mini Library: "${prompt}"`, url);
    }

    // Full Library Modal Functions
    function openFullLibrary() {
      const modal = document.getElementById('full-library-modal');
      modal.classList.add('show');
      renderFullLibrary();
    }

    function closeFullLibrary() {
      const modal = document.getElementById('full-library-modal');
      modal.classList.remove('show');
    }

    function renderFullLibrary() {
      const grid = document.getElementById('full-library-grid');

      if (miniLibrary.length === 0) {
        grid.innerHTML = `
          <div class="full-library-empty">
            <div class="full-library-empty-icon">📚</div>
            <div>No images saved yet</div>
            <div style="font-size:12px; margin-top:8px">Generated images will automatically appear here</div>
          </div>
        `;
        return;
      }

      grid.innerHTML = miniLibrary.map(img => {
        const date = new Date(img.timestamp);
        const timeStr = date.toLocaleString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });

        return `
          <div class="full-library-item">
            <img src="${img.url}" alt="${img.prompt}" class="full-library-item-image" onclick="viewLibraryImageFull('${img.url}', '${img.prompt.replace(/'/g, "\\'")}')">
            <div class="full-library-item-info">
              <div class="full-library-item-prompt" title="${img.prompt}">${img.prompt}</div>
              <div class="full-library-item-meta">
                <span>⏰ ${timeStr}</span>
              </div>
              <div class="full-library-item-actions">
                <button class="full-library-item-btn save" onclick="saveToMainLibrary('${img.id}', event)">
                  💾 Save to Library
                </button>
                <button class="full-library-item-btn delete" onclick="deleteFromMiniLibrary('${img.id}', event)">
                  🗑️
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function viewLibraryImageFull(url, prompt) {
      closeFullLibrary();
      addMessage('assistant', `📚 From Mini Library: "${prompt}"`, url);
    }

    // OLD GHOST CODE ARCHIVED - saveToMainLibrary used old localStorage

    async function deleteFromMiniLibrary(imageId, event) {
      event?.stopPropagation();

      if (!confirm('Delete this image from Mini Library?')) return;

      try {
        const response = await fetch(`/api/library/${imageId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          // Remove from local array
          miniLibrary = miniLibrary.filter(i => i.id != imageId);
          renderMiniLibrary();
          renderFullLibrary();
        } else {
          alert('Failed to delete from library');
        }
      } catch (error) {
        alert('Error deleting from library');
      }
    }

    // Close modal on background click
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('full-library-modal');
      modal?.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeFullLibrary();
        }
      });
    });

    // Check for reference image from library
    function checkForReferenceFromLibrary() {
      const imageData = sessionStorage.getItem('reference_image_data');
      const imageName = sessionStorage.getItem('reference_image_name');

      if (imageData && imageName) {
        // Convert data URL to File object
        fetch(imageData)
          .then(res => res.blob())
          .then(blob => {
            const file = new File([blob], imageName, { type: 'image/png' });
            handleImageUpload(file);

            // Clear sessionStorage
            sessionStorage.removeItem('reference_image_data');
            sessionStorage.removeItem('reference_image_name');

            // Show confirmation message
            addMessage('assistant', `✨ Loaded "${imageName}" as reference image! You can now add a prompt to transform it.`);
          })
          .catch(err => {
            addMessage('assistant', `⚠️ Failed to load reference image: ${err.message}`);
          });
      }
    }

    // Load user's generation history from server
    async function loadUserHistory() {
      if (!token) return;

      try {
        const response = await fetch('/api/history?per=20', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) return;

        const data = await response.json();
        if (data.ok && data.items) {
          // Clear localStorage images for current session
          generatedImages = [];
          miniLibrary = [];

          // Load images from server history
          for (const item of data.items) {
            // Fetch the actual image
            const imgResponse = await fetch(`/api/history/${item.id}/png`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });

            if (imgResponse.ok) {
              const blob = await imgResponse.blob();
              const imageUrl = URL.createObjectURL(blob);

              const imageData = {
                id: item.id,
                url: imageUrl,
                prompt: item.prompt,
                timestamp: item.created_at
              };

              // Add to both Recent Generations and Mini Library
              generatedImages.push(imageData);
              miniLibrary.push(imageData);
            }
          }

          // Save Mini Library with user-specific key
          if (window.currentUserId) {
            const key = `mv_mini_library_${window.currentUserId}`;
            localStorage.setItem(key, JSON.stringify(miniLibrary));
          }

          // Update both displays
          updateImageGrid();
          renderMiniLibrary();
        }
      } catch (error) {
        // Silently fail - user can still generate new images
      }
    }

    // Initialize
    setupReferenceUpload();
    // Don't init sessions yet - wait for /api/me to load user-specific sessions
    initInterface();
    initMiniPlusMenu();
    renderMiniLibrary();
    checkForReferenceFromLibrary();
    loadUserHistory(); // Load user-specific images from server
  </script>
</body>
</html>