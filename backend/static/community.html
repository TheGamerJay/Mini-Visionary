<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Community ‚Äî Mini Visionary</title>
  <link rel="icon" href="/logo.png" />
  <style>
    :root{
      --bg-0:#0b0f19; --bg-1:#0f1629; --card:#0e1424; --sunken:#0b1020;
      --line:#3b82f6; --text:#e6eaf2; --muted:#9aa4b2; --ring:rgba(148,163,184,.25);
      --btn-start:#22d3ee; --btn-end:#ec4899;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text); min-height:100vh; display:flex; flex-direction:column;
      background:
        radial-gradient(1200px 600px at 10% -10%, #16213a 0%, transparent 60%),
        radial-gradient(1200px 600px at 110% 110%, #1b2a4b 0%, transparent 60%),
        linear-gradient(180deg, var(--bg-0), var(--bg-1));
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    }
    .header{display:flex; justify-content:space-between; align-items:center; padding:16px 24px; border-bottom:1px solid var(--ring)}
    .logo{display:flex; align-items:center; gap:12px; font-size:20px; font-weight:700; text-decoration:none; color:var(--text)}
    .logo img{width:32px; height:32px; border-radius:8px}
    .nav{display:flex; gap:16px; align-items:center}
    .nav a{color:var(--muted); text-decoration:none; padding:8px 12px; border-radius:8px; transition:all 0.2s}
    .nav a:hover, .nav a.active{color:var(--text); background:var(--sunken)}
    .container{max-width:900px; margin:0 auto; padding:40px 24px}
    h1{font-size:36px; font-weight:800; margin-bottom:8px; background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); background-clip:text; -webkit-background-clip:text; color:transparent}
    .subtitle{color:var(--muted); margin-bottom:32px}

    /* Avatar chip */
    .avatar-chip{display:grid; place-items:center; border-radius:50%; font-size:18px; user-select:none}
    .avatar-male-1{background:linear-gradient(135deg, #818cf8, #f0abfc, #22d3ee)}
    .avatar-male-2{background:linear-gradient(135deg, #6366f1, #d946ef, #06b6d4)}
    .avatar-male-3{background:linear-gradient(135deg, #8b5cf6, #f0abfc, #0ea5e9)}
    .avatar-female-1{background:linear-gradient(135deg, #f472b6, #f0abfc, #818cf8)}
    .avatar-female-2{background:linear-gradient(135deg, #fb7185, #f0abfc, #22d3ee)}
    .avatar-female-3{background:linear-gradient(135deg, #22d3ee, #f0abfc, #818cf8)}

    /* Composer */
    .composer{background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:24px; margin-bottom:32px}
    .composer-title{font-size:18px; font-weight:700; margin-bottom:16px; display:flex; justify-content:space-between; align-items:center}
    .composer-note{font-size:12px; color:var(--muted)}
    .avatar-picker{display:flex; flex-wrap:wrap; gap:12px; margin:16px 0}
    .avatar-btn{display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; background:rgba(255,255,255,0.05); border:1px solid var(--ring); cursor:pointer; transition:all 0.2s}
    .avatar-btn:hover{background:rgba(255,255,255,0.1)}
    .avatar-btn.active{border-color:rgba(255,255,255,0.4)}
    .avatar-btn span{font-size:13px}
    .form-group{margin-bottom:16px}
    .form-label{display:block; font-size:14px; color:var(--muted); margin-bottom:8px}
    .form-input, .form-select, .form-textarea{width:100%; padding:10px 12px; background:rgba(255,255,255,0.1); border:1px solid var(--ring); border-radius:12px; color:var(--text); font-family:inherit; font-size:14px}
    .form-textarea{min-height:100px; resize:vertical}
    .char-count{font-size:12px; color:var(--muted); margin-top:4px}
    .image-preview{border-radius:12px; overflow:hidden; border:1px solid var(--ring); background:rgba(255,255,255,0.05); margin-top:12px}
    .image-preview img{width:100%; height:auto; display:block}
    .image-placeholder{border-radius:12px; border:1px dashed rgba(255,255,255,0.15); background:rgba(255,255,255,0.05); padding:40px; text-align:center; color:var(--muted); font-size:14px}
    .btn{padding:10px 20px; border-radius:12px; font-weight:600; cursor:pointer; border:none; font-size:14px; transition:all 0.2s}
    .btn-primary{background:linear-gradient(90deg, #818cf8, #f0abfc, #22d3ee); color:#000}
    .btn-primary:hover{transform:translateY(-2px)}
    .btn-primary:disabled{opacity:0.6; cursor:not-allowed}
    .btn-secondary{background:rgba(255,255,255,0.1); border:1px solid var(--ring); color:var(--text)}
    .btn-actions{display:flex; gap:8px; justify-content:flex-end}

    /* Post card */
    .post-card{background:var(--card); border:1px solid var(--ring); border-radius:16px; overflow:hidden; margin-bottom:16px}
    .post-header{padding:16px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--ring)}
    .post-author{display:flex; align-items:center; gap:12px}
    .post-author-info{flex:1}
    .post-author-name{font-size:14px; font-weight:600; display:flex; align-items:center; gap:8px}
    .post-meta{font-size:12px; color:var(--muted)}
    .post-badge{font-size:11px; padding:4px 8px; border-radius:12px; background:rgba(251,191,36,0.1); border:1px solid rgba(251,191,36,0.3); color:#fbbf24}
    .post-image{background:#000; display:flex; justify-content:center; align-items:center; max-height:400px; overflow:hidden}
    .post-image img{max-width:100%; max-height:400px; width:auto; height:auto; display:block; object-fit:contain}
    .post-story{padding:16px; color:rgba(255,255,255,0.9); white-space:pre-wrap; line-height:1.6}
    .post-reactions{padding:12px 16px; display:flex; flex-wrap:wrap; gap:8px}
    .reaction-btn{padding:6px 12px; border-radius:20px; background:rgba(255,255,255,0.1); border:1px solid var(--ring); font-size:14px; cursor:pointer; transition:all 0.2s}
    .reaction-btn:hover{background:rgba(255,255,255,0.15)}
    .reaction-count{color:var(--muted); margin-left:4px}
    .post-actions{padding:12px 16px; border-top:1px solid var(--ring); display:flex; flex-wrap:wrap; gap:8px; font-size:13px}
    .action-btn{padding:6px 12px; border-radius:12px; background:rgba(255,255,255,0.1); border:1px solid var(--ring); cursor:pointer; transition:all 0.2s; display:inline-flex; align-items:center; gap:4px}
    .action-btn:hover{background:rgba(255,255,255,0.15)}

    .empty-state{text-align:center; padding:80px 20px; color:var(--muted); background:var(--card); border:1px solid var(--ring); border-radius:16px}
    .empty-title{font-size:20px; color:var(--text); margin-bottom:8px}
    .file-input{display:none}
  </style>
</head>
<body>
  <div class="header">
    <a href="/static/generate.html" class="logo">
      <img src="/logo.png" alt="Mini Visionary Logo">
      Mini Visionary
    </a>
    <nav class="nav">
      <a href="/static/guide.html">Guide</a>
      <a href="/static/gallery.html">Gallery</a>
      <a href="/static/community.html" class="active">Community</a>
      <a href="/static/library.html">Library</a>
      <a href="/static/store.html">üíé Store</a>
      <a href="/static/wallet.html">üí∞ Wallet</a>
      <a href="/static/profile.html">üßë Profile</a>
    </nav>
  </div>

  <div class="container">
    <h1>üë• Community Wall</h1>
    <p class="subtitle">Share anonymously with avatar IDs. Express yourself freely in our creative community.</p>

    <!-- Composer -->
    <div class="composer">
      <div class="composer-title">
        <span>Share your masterpiece (anonymous)</span>
        <span class="composer-note">Name is hidden ‚Äî avatar only</span>
      </div>

      <div class="form-group">
        <div class="form-label">Choose an avatar</div>
        <div class="avatar-picker" id="avatar-picker"></div>
      </div>

      <div class="form-group">
        <label class="form-label">Category</label>
        <select id="category-select" class="form-select">
          <option value="General">General</option>
          <option value="Showcase">Showcase</option>
          <option value="Poster Design">Poster Design</option>
          <option value="Concept Art">Concept Art</option>
          <option value="Photography">Photography</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Backstory / Inspiration (optional)</label>
        <textarea id="story-input" class="form-textarea" maxlength="1200" placeholder="What sparked this piece? Tools, mood, influences‚Ä¶ (optional)"></textarea>
        <div class="char-count"><span id="char-count">0</span>/1200</div>
      </div>

      <div class="form-group">
        <div class="form-label">Artwork image</div>
        <button class="btn btn-secondary" onclick="document.getElementById('file-input').click()">Upload Image</button>
        <input type="file" id="file-input" class="file-input" accept="image/*" onchange="handleFileUpload(event)">
        <div id="image-preview"></div>
      </div>

      <div class="btn-actions">
        <button class="btn btn-primary" id="post-btn" onclick="submitPost()" disabled>Post Anonymously</button>
      </div>
    </div>

    <!-- Posts Feed -->
    <div id="posts-feed"></div>

    <div id="empty-state" class="empty-state" style="display:none;">
      <div class="empty-title">No posts yet</div>
      <div>Be the first to share your masterpiece ‚ú®</div>
    </div>
  </div>

  <script>
    // Check authentication
    const token = localStorage.getItem('jwt_token');
    if (!token) {
      window.location.href = '/auth.html#login';
    }

    // Avatar configuration
    const AVATARS = [
      { key: 'm1', label: 'Male 1', emoji: 'üßë‚Äçüé®', tone: 'avatar-male-1' },
      { key: 'm2', label: 'Male 2', emoji: 'üßî‚Äç‚ôÇÔ∏è', tone: 'avatar-male-2' },
      { key: 'm3', label: 'Male 3', emoji: 'üë®‚Äçüíª', tone: 'avatar-male-3' },
      { key: 'f1', label: 'Female 1', emoji: 'üë©‚Äçüé®', tone: 'avatar-female-1' },
      { key: 'f2', label: 'Female 2', emoji: 'üë©‚Äçüíª', tone: 'avatar-female-2' },
      { key: 'f3', label: 'Female 3', emoji: 'üë©', tone: 'avatar-female-3' }
    ];

    const REACTION_SET = ['‚ù§Ô∏è', '‚ú®', 'üåø', 'üî•', 'üôè', '‚≠ê', 'üëè', 'ü´∂'];

    // State
    let selectedAvatar = 'm1';
    let previewImage = null;
    let posts = [
      {
        id: 'seed1',
        createdAt: new Date(Date.now() - 9 * 24 * 3600000).toISOString(),
        category: 'General',
        story: 'First post on the community wall!',
        avatarKey: 'm1',
        imageUrl: null,
        mine: false,
        reactions: {},
        reported: false
      }
    ];

    // Initialize
    function init() {
      renderAvatarPicker();
      loadPosts();
      renderPosts();
      updatePostButton();

      document.getElementById('story-input').addEventListener('input', (e) => {
        document.getElementById('char-count').textContent = e.target.value.length;
        updatePostButton();
      });
    }

    function renderAvatarPicker() {
      const picker = document.getElementById('avatar-picker');
      picker.innerHTML = AVATARS.map(a => `
        <button class="avatar-btn ${a.key === selectedAvatar ? 'active' : ''}" onclick="selectAvatar('${a.key}')">
          <div class="avatar-chip ${a.tone}" style="width:28px; height:28px; font-size:14px;">${a.emoji}</div>
          <span>${a.label}</span>
        </button>
      `).join('');
    }

    function selectAvatar(key) {
      selectedAvatar = key;
      renderAvatarPicker();
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage = e.target.result;
        document.getElementById('image-preview').innerHTML = `
          <div class="image-preview">
            <img src="${previewImage}" alt="preview">
          </div>
        `;
        updatePostButton();
      };
      reader.readAsDataURL(file);
    }

    function updatePostButton() {
      const story = document.getElementById('story-input').value.trim();
      const btn = document.getElementById('post-btn');
      btn.disabled = !previewImage && !story;
    }

    function submitPost() {
      const category = document.getElementById('category-select').value;
      const story = document.getElementById('story-input').value.trim();

      const newPost = {
        id: `p_${Date.now()}`,
        createdAt: new Date().toISOString(),
        category: category,
        story: story || undefined,
        imageUrl: previewImage,
        avatarKey: selectedAvatar,
        mine: true,
        reactions: {},
        reported: false
      };

      posts.unshift(newPost);
      savePosts();
      renderPosts();

      // Reset form
      document.getElementById('story-input').value = '';
      document.getElementById('char-count').textContent = '0';
      document.getElementById('category-select').value = 'General';
      document.getElementById('file-input').value = '';
      document.getElementById('image-preview').innerHTML = '';
      previewImage = null;
      updatePostButton();
    }

    function renderPosts() {
      const feed = document.getElementById('posts-feed');
      const empty = document.getElementById('empty-state');

      if (posts.length === 0) {
        feed.innerHTML = '';
        empty.style.display = 'block';
        return;
      }

      empty.style.display = 'none';
      feed.innerHTML = posts.map(post => {
        const avatar = AVATARS.find(a => a.key === post.avatarKey) || AVATARS[0];
        return `
          <article class="post-card">
            <div class="post-header">
              <div class="post-author">
                <div class="avatar-chip ${avatar.tone}" style="width:40px; height:40px;">${avatar.emoji}</div>
                <div class="post-author-info">
                  <div class="post-author-name">
                    <span>üë§ Anonymous</span>
                    <span style="color:var(--muted)">‚Ä¢</span>
                    <span style="color:var(--muted)">${new Date(post.createdAt).toLocaleString()}</span>
                  </div>
                  <div class="post-meta">üí¨ ${post.category}</div>
                </div>
              </div>
              ${post.reported ? '<span class="post-badge">Reported</span>' : ''}
            </div>

            ${post.imageUrl ? `
              <div class="post-image">
                <img src="${post.imageUrl}" alt="artwork">
              </div>
            ` : ''}

            ${post.story ? `
              <div class="post-story">${post.story}</div>
            ` : ''}

            <div class="post-reactions">
              ${REACTION_SET.map(emoji => `
                <button class="reaction-btn" onclick="react('${post.id}', '${emoji}')">
                  ${emoji}
                  ${post.reactions[emoji] ? `<span class="reaction-count">${post.reactions[emoji]}</span>` : ''}
                </button>
              `).join('')}
            </div>

            <div class="post-actions">
              ${post.mine ? `<button class="action-btn" onclick="deletePost('${post.id}')">üóëÔ∏è Delete My Post</button>` : ''}
              <button class="action-btn" onclick="reportPost('${post.id}')">Report</button>
              <button class="action-btn" onclick="flagCategory('${post.id}')">Flag Category</button>
              <button class="action-btn" onclick="suggestReview('${post.id}')">Suggest Review</button>
            </div>
          </article>
        `;
      }).join('');
    }

    function react(id, emoji) {
      const post = posts.find(p => p.id === id);
      if (!post) return;

      post.reactions[emoji] = (post.reactions[emoji] || 0) + 1;
      savePosts();
      renderPosts();
    }

    function deletePost(id) {
      if (!confirm('Delete this post?')) return;
      posts = posts.filter(p => p.id !== id);
      savePosts();
      renderPosts();
    }

    function reportPost(id) {
      const post = posts.find(p => p.id === id);
      if (!post) return;

      post.reported = true;
      savePosts();
      renderPosts();
      alert('Post flagged for review. Thank you.');
    }

    function flagCategory(id) {
      alert("Thanks! We'll review this post's category.");
    }

    function suggestReview(id) {
      alert('Sent to moderators for review.');
    }

    function savePosts() {
      const userPosts = posts.filter(p => p.mine);
      localStorage.setItem('mv_community_posts', JSON.stringify(userPosts));
    }

    function loadPosts() {
      const saved = localStorage.getItem('mv_community_posts');
      if (saved) {
        try {
          const userPosts = JSON.parse(saved);
          posts = [...userPosts, ...posts];
        } catch (e) {
          console.error('Failed to load posts:', e);
        }
      }
    }

    init();
  </script>
</body>
</html>