<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Community — Mini Visionary</title>
  <link rel="icon" href="/logo.png" />
  <style>
    :root{
      --bg-0:#0b0f19; --bg-1:#0f1629; --card:#0e1424; --sunken:#0b1020;
      --line:#3b82f6; --text:#e6eaf2; --muted:#9aa4b2; --ring:rgba(148,163,184,.25);
      --btn-start:#22d3ee; --btn-end:#ec4899;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text); min-height:100vh; display:flex; flex-direction:column;
      background:
        radial-gradient(1200px 600px at 10% -10%, #16213a 0%, transparent 60%),
        radial-gradient(1200px 600px at 110% 110%, #1b2a4b 0%, transparent 60%),
        linear-gradient(180deg, var(--bg-0), var(--bg-1));
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    }
    .header{display:flex; justify-content:space-between; align-items:center; padding:16px 24px; border-bottom:1px solid var(--ring)}
    .logo{display:flex; align-items:center; gap:12px; font-size:20px; font-weight:700; text-decoration:none; color:var(--text)}
    .logo img{width:32px; height:32px; border-radius:8px}
    .nav{display:flex; gap:16px; align-items:center}
    .nav a{color:var(--muted); text-decoration:none; padding:8px 12px; border-radius:8px; transition:all 0.2s}
    .nav a:hover, .nav a.active{color:var(--text); background:var(--sunken)}
    .container{max-width:900px; margin:0 auto; padding:40px 24px}

    /* Hero */
    .hero{margin-bottom:32px}
    .hero-title{font-size:42px; font-weight:800; margin:0 0 8px 0; background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); background-clip:text; -webkit-background-clip:text; color:transparent}
    .subtitle{color:var(--muted); font-size:16px; margin:0}

    /* Stats Card */
    .stats-card{
      background:linear-gradient(135deg, var(--card) 0%, var(--sunken) 100%);
      border:1px solid var(--line);
      border-radius:16px;
      padding:24px;
      margin-bottom:24px;
    }
    .stats-title{font-size:18px; font-weight:700; margin-bottom:16px}
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:16px;
    }
    @media (max-width: 768px) { .stats-grid{grid-template-columns:repeat(2, 1fr)} }
    .stat-item{
      text-align:center;
      padding:12px;
      background:rgba(255,255,255,0.05);
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.1);
    }
    .stat-value{
      display:block;
      font-size:24px;
      font-weight:700;
      color:var(--btn-start);
      margin-bottom:4px;
    }
    .stat-label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    /* Composer Card */
    .composer{
      background:var(--card);
      border:1px solid var(--ring);
      border-radius:16px;
      padding:24px;
      margin-bottom:24px;
    }
    .composer-title{font-size:20px; font-weight:700; margin-bottom:20px}

    .post-selectors{
      display:flex;
      gap:12px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }
    .selector-group{
      flex:1;
      min-width:150px;
    }
    .selector-group label{
      display:block;
      color:var(--muted);
      font-size:12px;
      margin-bottom:6px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .form-select{
      width:100%;
      padding:10px 12px;
      background:rgba(255,255,255,0.1);
      border:1px solid var(--ring);
      border-radius:12px;
      color:var(--text);
      font-size:14px;
      transition:all 0.2s;
    }
    .form-select:focus{
      background:rgba(255,255,255,0.15);
      border-color:var(--line);
      outline:none;
    }
    .form-select option{
      background:var(--card);
      color:var(--text);
    }

    .form-textarea{
      width:100%;
      min-height:100px;
      padding:12px;
      background:rgba(255,255,255,0.1);
      border:1px solid var(--ring);
      border-radius:12px;
      color:var(--text);
      font-family:inherit;
      font-size:14px;
      resize:vertical;
      transition:all 0.2s;
    }
    .form-textarea:focus{
      background:rgba(255,255,255,0.15);
      border-color:var(--line);
      outline:none;
    }
    .char-count{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      text-align:right;
    }
    .composer-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:16px;
    }
    .composer-note{
      font-size:11px;
      color:var(--muted);
    }
    .btn{
      padding:12px 24px;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      border:none;
      font-size:14px;
      transition:all 0.2s;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn-primary{
      background:linear-gradient(90deg, var(--btn-start), var(--btn-end));
      color:#081018;
    }
    .btn-primary:hover:not(:disabled){
      transform:translateY(-2px);
      box-shadow:0 8px 24px rgba(34,211,238,0.3);
    }
    .btn-primary:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    .btn-secondary{
      background:var(--card);
      border:1px solid var(--ring);
      color:var(--text);
    }
    .btn-secondary:hover{
      background:var(--sunken);
      border-color:var(--line);
    }
    .btn-danger{
      background:rgba(239,68,68,0.2);
      border:1px solid rgba(239,68,68,0.4);
      color:#ef4444;
    }
    .btn-danger:hover{
      background:rgba(239,68,68,0.3);
      border-color:#ef4444;
    }

    /* Post Cards */
    .post-card{
      background:var(--card);
      border:1px solid var(--ring);
      border-radius:16px;
      overflow:hidden;
      margin-bottom:20px;
      transition:all 0.3s;
    }
    .post-card:hover{
      border-color:var(--line);
      box-shadow:0 8px 24px rgba(0,0,0,0.3);
    }
    .post-header{
      padding:16px;
      display:flex;
      align-items:center;
      gap:12px;
      border-bottom:1px solid var(--ring);
    }
    .user-avatar{
      width:48px;
      height:48px;
      border-radius:50%;
      background:linear-gradient(135deg, var(--btn-start), var(--btn-end));
      display:grid;
      place-items:center;
      font-size:20px;
      font-weight:700;
      color:#081018;
      flex-shrink:0;
    }
    .user-avatar img, .user-avatar video{
      width:100%;
      height:100%;
      border-radius:50%;
      object-fit:cover;
    }
    .post-meta-container{
      flex:1;
    }
    .post-author{
      font-size:15px;
      font-weight:600;
      margin-bottom:2px;
    }
    .post-meta{
      font-size:12px;
      color:var(--muted);
    }
    .post-actions-header{
      display:flex;
      gap:8px;
    }
    .post-content{
      padding:16px;
      color:rgba(255,255,255,0.9);
      white-space:pre-wrap;
      line-height:1.6;
      font-size:14px;
    }
    .post-image{
      background:#000;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .post-image img{
      max-width:100%;
      max-height:500px;
      width:auto;
      height:auto;
      display:block;
      object-fit:contain;
    }

    /* Reactions */
    .reaction-section{
      padding:16px;
      border-top:1px solid var(--ring);
    }
    .reaction-buttons{
      display:flex;
      gap:8px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .reaction-btn{
      padding:8px 12px;
      font-size:20px;
      border-radius:20px;
      transition:all 0.2s;
      background:rgba(255,255,255,0.1);
      border:1px solid rgba(255,255,255,0.2);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .reaction-btn:hover{
      background:rgba(255,255,255,0.2);
      transform:scale(1.1);
    }
    .reaction-btn.reaction-active{
      background:var(--btn-start);
      border-color:var(--btn-start);
      box-shadow:0 0 10px rgba(34,211,238,0.3);
    }
    .reaction-count{
      font-size:12px;
      color:var(--text);
    }
    .reaction-counts{
      font-size:13px;
      color:var(--muted);
    }
    .total-reactions{
      color:var(--btn-start);
      font-weight:700;
    }

    .empty-state{
      text-align:center;
      padding:80px 20px;
      color:var(--muted);
      background:var(--card);
      border:1px solid var(--ring);
      border-radius:16px;
    }
    .empty-state h3{
      color:var(--text);
      font-size:24px;
      margin-bottom:12px;
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="/static/generate.html" class="logo">
      <img src="/logo.png" alt="Mini Visionary Logo">
      Mini Visionary
    </a>
    <nav class="nav">
      <a href="/static/guide.html">Guide</a>
      <a href="/static/gallery.html">Gallery</a>
      <a href="/static/community.html" class="active">Community</a>
      <a href="/static/library.html">Library</a>
      <a href="/static/store.html">💎 Store</a>
      <a href="/static/wallet.html">💰 Wallet</a>
      <a href="/static/profile.html">🧑 Profile</a>
    </nav>
  </div>

  <div class="container">
    <div class="hero">
      <h1 class="hero-title">👥 Community</h1>
      <p class="subtitle">Share your creations and connect with other visionaries</p>
    </div>

    <!-- User Stats -->
    <div class="stats-card" id="user-stats" style="display:none;">
      <h3 class="stats-title">📊 Your Activity</h3>
      <div class="stats-grid">
        <div class="stat-item">
          <span class="stat-value" id="stat-posts-remaining">10</span>
          <span class="stat-label">Posts left today</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="stat-reactions-remaining">50</span>
          <span class="stat-label">Reactions left</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="stat-total-posts">0</span>
          <span class="stat-label">Total posts</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="stat-total-reactions">0</span>
          <span class="stat-label">Reactions received</span>
        </div>
      </div>
    </div>

    <!-- Post Composer -->
    <div class="composer">
      <h3 class="composer-title">✍️ Share Something</h3>

      <div class="post-selectors">
        <div class="selector-group">
          <label for="category-select">Category</label>
          <select id="category-select" class="form-select">
            <option value="general">General</option>
            <option value="showcase">Showcase</option>
            <option value="poster-design">Poster Design</option>
            <option value="concept-art">Concept Art</option>
            <option value="tips">Tips & Tricks</option>
            <option value="feedback">Feedback</option>
          </select>
        </div>
        <div class="selector-group">
          <label for="content-type-select">Type</label>
          <select id="content-type-select" class="form-select">
            <option value="general">General</option>
            <option value="achievement">Achievement</option>
            <option value="question">Question</option>
            <option value="tutorial">Tutorial</option>
            <option value="inspiration">Inspiration</option>
          </select>
        </div>
      </div>

      <textarea
        id="post-body"
        class="form-textarea"
        placeholder="Share your latest creation, ask a question, or inspire others..."
        maxlength="500"
      ></textarea>
      <div class="char-count"><span id="char-count">0</span>/500</div>

      <div class="composer-footer">
        <div class="composer-note">
          🕒 2-minute cooldown • 10 posts per day limit
        </div>
        <button class="btn btn-primary" id="post-btn" onclick="submitPost()">
          <span>🚀</span>
          <span>Post</span>
        </button>
      </div>
    </div>

    <!-- Posts Feed -->
    <div id="posts-feed"></div>

    <div id="empty-state" class="empty-state" style="display:none;">
      <h3>Welcome to the Community!</h3>
      <p>No posts yet. Be the first to share something amazing!</p>
    </div>
  </div>

  <script>
    // Check authentication
    const token = localStorage.getItem('jwt_token');
    if (!token) {
      window.location.href = '/auth.html#login';
    }

    const REACTION_SET = ['❤️', '✨', '🌿', '🔥', '🙏', '⭐', '👏', '🫶'];

    // State
    let userPosts = [];
    let myUserId = null;

    // Initialize
    function init() {
      loadPosts();

      const textarea = document.getElementById('post-body');
      textarea.addEventListener('input', (e) => {
        document.getElementById('char-count').textContent = e.target.value.length;
      });

      // Show user stats
      document.getElementById('user-stats').style.display = 'block';
    }

    function loadPosts() {
      const saved = localStorage.getItem('community_posts');
      if (saved) {
        try {
          userPosts = JSON.parse(saved);
        } catch(e) {
          console.error('Failed to load posts:', e);
        }
      }

      renderPosts();
    }

    function savePosts() {
      localStorage.setItem('community_posts', JSON.stringify(userPosts));
    }

    function renderPosts() {
      const feed = document.getElementById('posts-feed');
      const empty = document.getElementById('empty-state');

      if (userPosts.length === 0) {
        feed.innerHTML = '';
        empty.style.display = 'block';
        return;
      }

      empty.style.display = 'none';

      // Sort by date, newest first
      const sortedPosts = [...userPosts].sort((a, b) =>
        new Date(b.createdAt) - new Date(a.createdAt)
      );

      feed.innerHTML = sortedPosts.map(post => {
        const totalReactions = Object.values(post.reactions || {}).reduce((sum, count) => sum + count, 0);
        const myReaction = post.myReaction || null;

        return `
          <div class="post-card">
            <div class="post-header">
              <div class="user-avatar">
                ${post.userName ? post.userName[0].toUpperCase() : 'U'}
              </div>
              <div class="post-meta-container">
                <div class="post-author">${post.userName || 'Anonymous'}</div>
                <div class="post-meta">${new Date(post.createdAt).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit'})}</div>
              </div>
              <div class="post-actions-header">
                ${post.mine ? `
                  <button class="btn btn-danger" onclick="deletePost('${post.id}')" title="Delete post">
                    🗑️
                  </button>
                ` : `
                  <button class="btn btn-secondary" onclick="reportPost('${post.id}')" title="Report post">
                    ⚠️
                  </button>
                `}
              </div>
            </div>

            ${post.body ? `<div class="post-content">${post.body}</div>` : ''}

            ${post.imageUrl ? `
              <div class="post-image">
                <img src="${post.imageUrl}" alt="Post image">
              </div>
            ` : ''}

            <div class="reaction-section">
              <div class="reaction-buttons">
                ${REACTION_SET.map(emoji => {
                  const count = post.reactions?.[emoji] || 0;
                  const isActive = myReaction === emoji;
                  return `
                    <button
                      class="reaction-btn ${isActive ? 'reaction-active' : ''}"
                      onclick="toggleReaction('${post.id}', '${emoji}')"
                      title="${emoji}">
                      <span>${emoji}</span>
                      ${count > 0 ? `<span class="reaction-count">${count}</span>` : ''}
                    </button>
                  `;
                }).join('')}
              </div>
              <div class="reaction-counts">
                Total reactions: <span class="total-reactions">${totalReactions}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function submitPost() {
      const body = document.getElementById('post-body').value.trim();
      const category = document.getElementById('category-select').value;
      const contentType = document.getElementById('content-type-select').value;

      if (!body) {
        alert('Please write something to post');
        return;
      }

      const newPost = {
        id: `post_${Date.now()}`,
        body: body,
        category: category,
        contentType: contentType,
        createdAt: new Date().toISOString(),
        userName: 'You', // Will be replaced with real user data
        mine: true,
        reactions: {},
        myReaction: null
      };

      userPosts.push(newPost);
      savePosts();
      renderPosts();

      // Clear form
      document.getElementById('post-body').value = '';
      document.getElementById('char-count').textContent = '0';
      document.getElementById('category-select').value = 'general';
      document.getElementById('content-type-select').value = 'general';

      alert('Post shared successfully! 🎉');
    }

    function toggleReaction(postId, emoji) {
      const post = userPosts.find(p => p.id === postId);
      if (!post) return;

      // Initialize reactions if not exists
      if (!post.reactions) post.reactions = {};

      // If already reacted with this emoji, remove it
      if (post.myReaction === emoji) {
        post.reactions[emoji] = (post.reactions[emoji] || 1) - 1;
        if (post.reactions[emoji] <= 0) delete post.reactions[emoji];
        post.myReaction = null;
      } else {
        // Remove old reaction if exists
        if (post.myReaction && post.reactions[post.myReaction]) {
          post.reactions[post.myReaction] = (post.reactions[post.myReaction] || 1) - 1;
          if (post.reactions[post.myReaction] <= 0) delete post.reactions[post.myReaction];
        }
        // Add new reaction
        post.reactions[emoji] = (post.reactions[emoji] || 0) + 1;
        post.myReaction = emoji;
      }

      savePosts();
      renderPosts();
    }

    function deletePost(postId) {
      if (!confirm('Delete this post? This cannot be undone.')) return;

      userPosts = userPosts.filter(p => p.id !== postId);
      savePosts();
      renderPosts();
    }

    function reportPost(postId) {
      alert('Post reported. Thank you for helping keep our community safe.');
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
