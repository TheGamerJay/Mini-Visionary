<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gallery — Mini Visionary</title>
  <link rel="icon" href="/logo.png" />
  <style>
    :root{
      --bg-0:#0b0f19; --bg-1:#0f1629; --card:#0e1424; --sunken:#0b1020;
      --line:#3b82f6; --text:#e6eaf2; --muted:#9aa4b2; --ring:rgba(148,163,184,.25);
      --btn-start:#22d3ee; --btn-end:#ec4899;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text); min-height:100vh; display:flex; flex-direction:column;
      background:
        radial-gradient(1200px 600px at 10% -10%, #16213a 0%, transparent 60%),
        radial-gradient(1200px 600px at 110% 110%, #1b2a4b 0%, transparent 60%),
        linear-gradient(180deg, var(--bg-0), var(--bg-1));
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    }
    .header{display:flex; justify-content:space-between; align-items:center; padding:16px 24px; border-bottom:1px solid var(--ring)}
    .logo{display:flex; align-items:center; gap:12px; font-size:20px; font-weight:700; text-decoration:none; color:var(--text)}
    .logo img{width:32px; height:32px; border-radius:8px}
    .nav{display:flex; gap:16px; align-items:center}
    .nav a{color:var(--muted); text-decoration:none; padding:8px 12px; border-radius:8px; transition:all 0.2s}
    .nav a:hover, .nav a.active{color:var(--text); background:var(--sunken)}
    .container{max-width:1400px; margin:0 auto; padding:40px 24px}
    h1{font-size:36px; font-weight:800; margin-bottom:8px; background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); background-clip:text; -webkit-background-clip:text; color:transparent}
    .subtitle{color:var(--muted); margin-bottom:24px}

    /* Filter section */
    .filter-section{background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:20px; margin-bottom:32px}
    .filter-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:16px}
    .filter-label{display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted); margin-bottom:6px}
    .filter-number{display:inline-flex; align-items:center; justify-content:center; width:20px; height:20px; background:var(--sunken); border:1px solid var(--ring); border-radius:50%; font-size:11px}
    .filter-input, .filter-select{width:100%; padding:10px 12px; background:var(--sunken); border:1px solid var(--ring); border-radius:8px; color:var(--text); font-size:14px}
    .filter-input:focus, .filter-select:focus{outline:none; border-color:var(--line)}
    .time-window{background:var(--sunken); border:1px solid var(--ring); border-radius:12px; padding:16px; margin-bottom:16px}
    .time-inputs{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px}
    .filter-actions{display:flex; gap:8px; flex-wrap:wrap}
    .btn{padding:10px 20px; border-radius:8px; font-size:14px; cursor:pointer; transition:all 0.2s; border:none}
    .btn-clear{background:var(--sunken); border:1px solid var(--ring); color:var(--text)}
    .btn-clear:hover{background:var(--card); border-color:var(--line)}
    .btn-primary{background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); color:#081018; font-weight:700}
    .btn-primary:hover{transform:translateY(-1px)}
    .btn-upload{background:var(--card); border:1px solid var(--ring); color:var(--text)}
    .btn-upload:hover{border-color:var(--line)}

    /* Gallery grid - masonry layout */
    .gallery-grid{column-count:5; column-gap:10px; margin-top:32px}
    @media (max-width: 1400px) { .gallery-grid{column-count:4} }
    @media (max-width: 1200px) { .gallery-grid{column-count:3} }
    @media (max-width: 768px) { .gallery-grid{column-count:2} }
    @media (max-width: 480px) { .gallery-grid{column-count:1} }

    .gallery-item{background:var(--card); border:1px solid var(--ring); border-radius:8px; overflow:hidden; margin-bottom:10px; break-inside:avoid; transition:all 0.2s; position:relative}
    .gallery-item:hover{border-color:var(--line); box-shadow:0 4px 16px rgba(0,0,0,0.3)}
    .gallery-item img{width:100%; height:auto; max-height:250px; object-fit:contain; display:block; cursor:pointer; background:#000}
    .gallery-info{padding:8px; position:relative}
    .gallery-title{font-size:12px; font-weight:600; color:var(--text); margin-bottom:6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .gallery-meta{display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px}
    .gallery-date{font-size:11px; color:var(--muted)}
    .gallery-tags{display:flex; gap:4px; flex-wrap:wrap}
    .tag{padding:3px 8px; background:var(--sunken); border:1px solid var(--ring); border-radius:6px; font-size:11px; color:var(--muted)}
    .gallery-actions{display:flex; flex-direction:column; gap:6px; margin-top:6px}
    .gallery-reactions{display:flex; gap:3px; flex-wrap:wrap}
    .reaction-btn{padding:4px 6px; background:var(--sunken); border:1px solid var(--ring); border-radius:4px; font-size:14px; cursor:pointer; transition:all 0.2s}
    .reaction-btn:hover{background:var(--card); border-color:var(--line)}
    .reaction-btn.active{background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); color:#081018; border:none}
    .btn-delete{padding:4px 8px; background:#ef4444; border:none; border-radius:6px; font-size:11px; color:white; cursor:pointer; transition:all 0.2s}
    .btn-delete:hover{background:#dc2626}

    /* Modal */
    .modal{display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center; padding:20px}
    .modal.active{display:flex}
    .modal-content{background:var(--card); border:1px solid var(--ring); border-radius:16px; max-width:900px; width:100%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column}
    .modal-header{display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid var(--ring)}
    .modal-title{font-weight:600; color:var(--text); font-size:16px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1}
    .modal-actions{display:flex; gap:8px}
    .modal-img{width:100%; max-height:60vh; object-fit:contain; background:#000}
    .modal-footer{padding:16px 20px; border-top:1px solid var(--ring); display:flex; justify-content:space-between; align-items:center}

    .empty-state{text-align:center; padding:80px 20px; color:var(--muted); background:var(--card); border:1px solid var(--ring); border-radius:16px}

    /* Upload modal */
    .upload-modal{display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:1001; align-items:center; justify-content:center; padding:20px}
    .upload-modal.active{display:flex}
    .upload-content{background:var(--card); border:1px solid var(--ring); border-radius:16px; max-width:500px; width:100%; padding:24px}
    .upload-title{font-size:20px; font-weight:700; color:var(--text); margin-bottom:16px}
    .upload-form{display:grid; gap:16px}
    .form-group label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    .form-group input, .form-group textarea{width:100%; padding:10px 12px; background:var(--sunken); border:1px solid var(--ring); border-radius:8px; color:var(--text); font-size:14px; font-family:inherit}
    .form-group textarea{min-height:80px; resize:vertical}
    .file-input{cursor:pointer}
    .upload-actions{display:flex; gap:8px; justify-content:flex-end}
  </style>
</head>
<body>
  <div class="header">
    <a href="/static/generate.html" class="logo">
      <img src="/logo.png" alt="Mini Visionary Logo">
      Mini Visionary
    </a>
    <nav class="nav">
      <a href="/static/guide.html">Guide</a>
      <a href="/static/gallery.html" class="active">Gallery</a>
      <a href="/static/library.html">Library</a>
      <a href="/static/store.html">💎 Store</a>
      <a href="/static/wallet.html">💰 Wallet</a>
      <a href="/static/profile.html">🧑 Profile</a>
    </nav>
  </div>

  <div class="container">
    <h1>🎨 Community Gallery</h1>
    <p class="subtitle">Explore masterpieces from the Mini Visionary community. Share your art and react to others.</p>

    <div class="filter-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div style="font-size: 18px; font-weight: 600; color: var(--text);">
          💎 Credits: <span id="user-credits" style="color: var(--btn-start);">Loading...</span>
        </div>
        <div style="font-size: 13px; color: var(--muted);">
          Posting costs 3 credits
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" onclick="openUploadModal()">📤 Post Your Masterpiece</button>
        <button class="btn btn-clear" onclick="scrollToTop()">Back to top</button>
      </div>
    </div>

    <div id="gallery-grid" class="gallery-grid"></div>
    <div id="empty-state" class="empty-state" style="display:none;">
      <h2 style="color:var(--text); margin-bottom:16px;">No results</h2>
      <p>Try a different keyword, date range, or clear filters.</p>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="modal" class="modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" id="modal-title"></div>
        <div class="modal-actions">
          <button class="btn btn-primary" onclick="saveImage()">Save</button>
          <button class="btn btn-clear" onclick="closeModal()">Close</button>
        </div>
      </div>
      <img id="modal-img" class="modal-img" loading="lazy" src="" alt="">
      <div class="modal-footer">
        <div class="gallery-tags" id="modal-tags"></div>
        <div class="gallery-date" id="modal-date"></div>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div id="upload-modal" class="upload-modal" onclick="closeUploadModal()">
    <div class="upload-content" onclick="event.stopPropagation()">
      <div class="upload-title">📤 Upload Image to Gallery</div>
      <form class="upload-form" onsubmit="uploadImage(event)">
        <div class="form-group">
          <label>Image File</label>
          <input type="file" id="upload-file" class="file-input" accept="image/*" required>
        </div>
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="upload-prompt" placeholder="Give your masterpiece a title..." required>
        </div>
        <div class="form-group">
          <label>Story / Inspiration (optional)</label>
          <textarea id="upload-story" placeholder="Share the story behind your art..."></textarea>
        </div>
        <div class="form-group">
          <label>Tags (comma-separated)</label>
          <input type="text" id="upload-tags" placeholder="e.g. poster, neon, portrait">
        </div>
        <div class="upload-actions">
          <button type="button" class="btn btn-clear" onclick="closeUploadModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Post</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Check authentication
    const token = localStorage.getItem('jwt_token');
    if (!token) {
      window.location.href = '/auth.html#login';
    }

    // Gallery state
    let galleryItems = [];
    let currentModal = null;
    let currentUserId = null;

    // Save user reactions per user
    function saveUserReaction(postId, reactionType) {
      if (!currentUserId) return;
      const key = `mv_user_reactions_${currentUserId}`;
      const reactions = JSON.parse(localStorage.getItem(key) || '{}');
      reactions[postId] = reactionType;
      localStorage.setItem(key, JSON.stringify(reactions));
    }

    // Load user reactions for current user
    function getUserReaction(postId) {
      if (!currentUserId) return null;
      const key = `mv_user_reactions_${currentUserId}`;
      const reactions = JSON.parse(localStorage.getItem(key) || '{}');
      return reactions[postId] || null;
    }

    // Save global reaction counts for all posts
    function saveReactionCounts(postId, reactionCounts) {
      const key = 'mv_global_reaction_counts';
      const allCounts = JSON.parse(localStorage.getItem(key) || '{}');
      allCounts[postId] = reactionCounts;
      localStorage.setItem(key, JSON.stringify(allCounts));
    }

    // Load global reaction counts for a post
    function getReactionCounts(postId) {
      const key = 'mv_global_reaction_counts';
      const allCounts = JSON.parse(localStorage.getItem(key) || '{}');
      return allCounts[postId] || {love: 0, magic: 0, peace: 0, fire: 0, gratitude: 0, star: 0, applause: 0, support: 0};
    }

    // Load gallery posts from backend
    async function loadDemoData() {
      try {
        // Fetch all gallery posts from backend
        const response = await fetch('/api/gallery/posts');
        const data = await response.json();

        if (data.ok && data.posts) {
          // Fetch user reactions for all posts
          const postsWithUserReactions = await Promise.all(
            data.posts.map(async (post) => {
              try {
                const reactionResponse = await fetch(`/api/gallery/${post.id}/my-reaction`, {
                  headers: { 'Authorization': `Bearer ${token}` }
                });
                const reactionData = await reactionResponse.json();
                return {
                  ...post,
                  userReacted: reactionData.reaction_type || null,
                  createdAt: post.created_at
                };
              } catch (e) {
                return { ...post, userReacted: null, createdAt: post.created_at };
              }
            })
          );

          galleryItems = postsWithUserReactions;
        } else {
          galleryItems = [];
        }

        renderGallery();
      } catch (error) {
        galleryItems = [];
        renderGallery();
      }
    }

    // Render gallery - simple community showcase
    function renderGallery() {
      // Sort by newest first
      const sorted = [...galleryItems].sort((a, b) => {
        return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
      });

      const grid = document.getElementById('gallery-grid');
      const empty = document.getElementById('empty-state');

      if (sorted.length === 0) {
        grid.innerHTML = '';
        empty.style.display = 'block';
      } else {
        empty.style.display = 'none';
        grid.innerHTML = sorted.map(item => `
          <div class="gallery-item" data-id="${item.id}">
            <img loading="lazy" src="${item.url}" alt="${item.prompt}" onclick="openModal('${item.id}')">
            <div class="gallery-info">
              <div class="gallery-title" title="${item.prompt}">${item.prompt}</div>
              ${item.story ? `<div style="font-size:13px; color:var(--muted); margin:8px 0; line-height:1.4;">${item.story}</div>` : ''}
              <div class="gallery-meta">
                <div class="gallery-date">${new Date(item.createdAt).toLocaleString()}</div>
              </div>
              <div class="gallery-tags">
                ${item.tags.map(t => `<span class="tag">${t}</span>`).join('')}
              </div>
              <div class="gallery-actions">
                <div class="gallery-reactions">
                  <button class="reaction-btn ${item.userReacted === 'love' ? 'active' : ''}" onclick="toggleReaction('${item.id}', 'love')">
                    ❤️ ${item.reactions.love}
                  </button>
                  <button class="reaction-btn ${item.userReacted === 'magic' ? 'active' : ''}" onclick="toggleReaction('${item.id}', 'magic')">
                    ✨ ${item.reactions.magic}
                  </button>
                  <button class="reaction-btn ${item.userReacted === 'peace' ? 'active' : ''}" onclick="toggleReaction('${item.id}', 'peace')">
                    🌿 ${item.reactions.peace}
                  </button>
                  <button class="reaction-btn ${item.userReacted === 'fire' ? 'active' : ''}" onclick="toggleReaction('${item.id}', 'fire')">
                    🔥 ${item.reactions.fire}
                  </button>
                  <button class="reaction-btn ${item.userReacted === 'gratitude' ? 'active' : ''}" onclick="toggleReaction('${item.id}', 'gratitude')">
                    🙏 ${item.reactions.gratitude}
                  </button>
                  <button class="reaction-btn ${item.userReacted === 'star' ? 'active' : ''}" onclick="toggleReaction('${item.id}', 'star')">
                    ⭐ ${item.reactions.star}
                  </button>
                  <button class="reaction-btn ${item.userReacted === 'applause' ? 'active' : ''}" onclick="toggleReaction('${item.id}', 'applause')">
                    👏 ${item.reactions.applause}
                  </button>
                  <button class="reaction-btn ${item.userReacted === 'support' ? 'active' : ''}" onclick="toggleReaction('${item.id}', 'support')">
                    🫶 ${item.reactions.support}
                  </button>
                </div>
                <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
                  Total reactions: ${Object.values(item.reactions).reduce((a, b) => a + b, 0)}
                </div>
                ${item.id.startsWith('uploaded_') ? `<button class="btn-delete" onclick="deleteImage('${item.id}')">🗑️ Delete</button>` : ''}
              </div>
            </div>
          </div>
        `).join('');
      }
    }

    async function toggleReaction(id, type) {
      const item = galleryItems.find(i => i.id === id);
      if (!item) return;

      const reactionEmojis = {
        'love': '❤️',
        'magic': '✨',
        'peace': '🌿',
        'fire': '🔥',
        'gratitude': '🙏',
        'star': '⭐',
        'applause': '👏',
        'support': '🫶'
      };

      // Check if user already reacted
      if (item.userReacted) {
        const existingEmoji = reactionEmojis[item.userReacted];
        alert(`You've already reacted to this post!\n\n${existingEmoji} Your ${item.userReacted} reaction is locked in.\n\n⚠️ You can only react once per post - reactions are permanent and cannot be changed.`);
        return;
      }

      // Show confirmation prompt
      const emoji = reactionEmojis[type];
      const confirmed = confirm(`Confirm Permanent Reaction\n${emoji}\n\nAre you sure you want to react with ${emoji}?\n\n⚠️ This reaction is permanent and cannot be changed or removed!`);

      if (!confirmed) return;

      // Call backend API to add reaction
      try {
        const response = await fetch(`/api/gallery/${id}/react`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ reaction_type: type })
        });

        const data = await response.json();

        if (data.ok) {
          // Update local state
          item.reactions[type]++;
          item.userReacted = type;
          renderGallery();
        } else {
          alert(`Failed to add reaction: ${data.error || 'Unknown error'}`);
        }
      } catch (error) {
        alert('Failed to add reaction. Please try again.');
      }
    }

    function deleteImage(id) {
      if (!confirm('Delete this image from the gallery?')) return;

      galleryItems = galleryItems.filter(i => i.id !== id);
      saveGallery();
      renderGallery();
    }

    function openModal(id) {
      const item = galleryItems.find(i => i.id === id);
      if (!item) return;

      currentModal = item;
      document.getElementById('modal-title').textContent = item.prompt;
      document.getElementById('modal-img').src = item.url;
      document.getElementById('modal-tags').innerHTML = item.tags.map(t => `<span class="tag">${t}</span>`).join('');
      document.getElementById('modal-date').textContent = new Date(item.createdAt).toLocaleString();
      document.getElementById('modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      currentModal = null;
    }

    function saveImage() {
      if (!currentModal) return;
      alert('Image saved to your library! (Feature coming soon)');
    }

    function openUploadModal() {
      document.getElementById('upload-modal').classList.add('active');
    }

    function closeUploadModal() {
      document.getElementById('upload-modal').classList.remove('active');
      document.getElementById('upload-file').value = '';
      document.getElementById('upload-prompt').value = '';
      document.getElementById('upload-story').value = '';
      document.getElementById('upload-tags').value = '';
    }

    async function uploadImage(event) {
      event.preventDefault();

      const fileInput = document.getElementById('upload-file');
      const prompt = document.getElementById('upload-prompt').value;
      const story = document.getElementById('upload-story').value;
      const tagsInput = document.getElementById('upload-tags').value;
      const tags = tagsInput.split(',').map(t => t.trim()).filter(t => t);

      if (!fileInput.files[0]) return;

      // Check user credits first
      try {
        const response = await fetch('/api/me', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await response.json();

        if (!data.ok) {
          alert('Failed to verify your account. Please try again.');
          return;
        }

        const userCredits = data.credits || 0;

        if (userCredits < 3) {
          alert(`Insufficient credits!\n\nYou need 3 credits to post to the gallery.\nYou currently have ${userCredits} credits.\n\nVisit the Store to purchase more credits.`);
          closeUploadModal();
          return;
        }

        // Confirm the cost
        const confirmed = confirm(`Post to Gallery\n\nThis will cost 3 credits.\n\nYou have ${userCredits} credits.\nAfter posting, you'll have ${userCredits - 3} credits.\n\nDo you want to continue?`);

        if (!confirmed) return;

        // Read file as base64
        const reader = new FileReader();
        reader.onload = async (e) => {
          const imageUrl = e.target.result; // base64 data URL

          // Send to backend
          try {
            const postResponse = await fetch('/api/gallery/post', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                prompt: prompt,
                story: story,
                tags: tags,
                image_url: imageUrl
              })
            });

            const postData = await postResponse.json();

            if (postData.ok) {
              // Reload gallery to show new post
              await loadDemoData();
              closeUploadModal();
              loadUserCredits();
              alert(`✅ Posted successfully!\n\n3 credits deducted.\nRemaining credits: ${postData.credits}`);
            } else {
              alert(`Failed to post: ${postData.error || 'Unknown error'}`);
            }
          } catch (error) {
            alert('Failed to upload image. Please try again.');
          }
        };

        reader.readAsDataURL(fileInput.files[0]);

      } catch (error) {
        console.error('Upload error:', error);
        alert('Failed to post. Please try again.');
      }
    }

    function saveGallery() {
      const userUploads = galleryItems.filter(i => i.id.startsWith('uploaded_'));
      localStorage.setItem('mv_gallery_items', JSON.stringify(userUploads));
    }

    function scrollToTop() {
      window.scrollTo({top: 0, behavior: 'smooth'});
    }

    // Load user credits and ID
    async function loadUserCredits() {
      try {
        const response = await fetch('/api/me', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.status === 401) {
          // Token expired or missing - redirect to login
          window.location.href = '/login.html';
          return;
        }

        const data = await response.json();
        if (data.ok) {
          document.getElementById('user-credits').textContent = data.credits || 0;
          // Set currentUserId for reaction persistence
          currentUserId = data.user?.id || data.id || data.email;
          // Reload demo data to apply user reactions
          loadDemoData();
        } else {
          document.getElementById('user-credits').textContent = '0';
        }
      } catch (error) {
        document.getElementById('user-credits').textContent = '0';
      }
    }

    // Initialize - load user first, then data
    loadUserCredits();
  </script>
</body>
</html>