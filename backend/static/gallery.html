<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gallery — Mini Visionary</title>
  <link rel="icon" href="/logo.png" />
  <style>
    :root{
      --bg-0:#0b0f19; --bg-1:#0f1629; --card:#0e1424; --sunken:#0b1020;
      --line:#3b82f6; --text:#e6eaf2; --muted:#9aa4b2; --ring:rgba(148,163,184,.25);
      --btn-start:#22d3ee; --btn-end:#ec4899;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text); min-height:100vh; display:flex; flex-direction:column;
      background:
        radial-gradient(1200px 600px at 10% -10%, #16213a 0%, transparent 60%),
        radial-gradient(1200px 600px at 110% 110%, #1b2a4b 0%, transparent 60%),
        linear-gradient(180deg, var(--bg-0), var(--bg-1));
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    }
    .header{display:flex; justify-content:space-between; align-items:center; padding:16px 24px; border-bottom:1px solid var(--ring)}
    .logo{display:flex; align-items:center; gap:12px; font-size:20px; font-weight:700; text-decoration:none; color:var(--text)}
    .logo img{width:32px; height:32px; border-radius:8px}
    .nav{display:flex; gap:16px; align-items:center}
    .nav a{color:var(--muted); text-decoration:none; padding:8px 12px; border-radius:8px; transition:all 0.2s}
    .nav a:hover, .nav a.active{color:var(--text); background:var(--sunken)}
    .container{max-width:1400px; margin:0 auto; padding:40px 24px}
    h1{font-size:36px; font-weight:800; margin-bottom:8px; background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); background-clip:text; -webkit-background-clip:text; color:transparent}
    .subtitle{color:var(--muted); margin-bottom:24px}

    /* Filter section */
    .filter-section{background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:20px; margin-bottom:32px}
    .filter-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:16px}
    .filter-label{display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted); margin-bottom:6px}
    .filter-number{display:inline-flex; align-items:center; justify-content:center; width:20px; height:20px; background:var(--sunken); border:1px solid var(--ring); border-radius:50%; font-size:11px}
    .filter-input, .filter-select{width:100%; padding:10px 12px; background:var(--sunken); border:1px solid var(--ring); border-radius:8px; color:var(--text); font-size:14px}
    .filter-input:focus, .filter-select:focus{outline:none; border-color:var(--line)}
    .time-window{background:var(--sunken); border:1px solid var(--ring); border-radius:12px; padding:16px; margin-bottom:16px}
    .time-inputs{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px}
    .filter-actions{display:flex; gap:8px; flex-wrap:wrap}
    .btn{padding:10px 20px; border-radius:8px; font-size:14px; cursor:pointer; transition:all 0.2s; border:none}
    .btn-clear{background:var(--sunken); border:1px solid var(--ring); color:var(--text)}
    .btn-clear:hover{background:var(--card); border-color:var(--line)}
    .btn-primary{background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); color:#081018; font-weight:700}
    .btn-primary:hover{transform:translateY(-1px)}
    .btn-upload{background:var(--card); border:1px solid var(--ring); color:var(--text)}
    .btn-upload:hover{border-color:var(--line)}

    /* Gallery grid - masonry layout */
    .gallery-grid{column-count:4; column-gap:12px; margin-top:32px}
    @media (max-width: 1200px) { .gallery-grid{column-count:3} }
    @media (max-width: 768px) { .gallery-grid{column-count:2} }
    @media (max-width: 480px) { .gallery-grid{column-count:1} }

    .gallery-item{background:var(--card); border:1px solid var(--ring); border-radius:8px; overflow:hidden; margin-bottom:12px; break-inside:avoid; transition:all 0.2s; position:relative}
    .gallery-item:hover{border-color:var(--line); box-shadow:0 4px 16px rgba(0,0,0,0.3)}
    .gallery-item img{width:100%; height:auto; max-height:300px; object-fit:contain; display:block; cursor:pointer; background:#000}
    .gallery-info{padding:8px; position:relative}
    .gallery-title{font-size:12px; font-weight:600; color:var(--text); margin-bottom:6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .gallery-meta{display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px}
    .gallery-date{font-size:11px; color:var(--muted)}
    .gallery-tags{display:flex; gap:4px; flex-wrap:wrap}
    .tag{padding:3px 8px; background:var(--sunken); border:1px solid var(--ring); border-radius:6px; font-size:11px; color:var(--muted)}
    .gallery-actions{display:flex; flex-direction:column; gap:6px; margin-top:6px}
    .gallery-reactions{display:flex; gap:3px; flex-wrap:wrap}
    .reaction-btn{padding:4px 6px; background:var(--sunken); border:1px solid var(--ring); border-radius:4px; font-size:14px; cursor:pointer; transition:all 0.2s}
    .reaction-btn:hover{background:var(--card); border-color:var(--line)}
    .reaction-btn.active{background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); color:#081018; border:none}
    .btn-delete{padding:4px 8px; background:#ef4444; border:none; border-radius:6px; font-size:11px; color:white; cursor:pointer; transition:all 0.2s}
    .btn-delete:hover{background:#dc2626}

    /* Modal */
    .modal{display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center; padding:20px}
    .modal.active{display:flex}
    .modal-content{background:var(--card); border:1px solid var(--ring); border-radius:16px; max-width:900px; width:100%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column}
    .modal-header{display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid var(--ring)}
    .modal-title{font-weight:600; color:var(--text); font-size:16px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1}
    .modal-actions{display:flex; gap:8px}
    .modal-img{width:100%; max-height:60vh; object-fit:contain; background:#000}
    .modal-footer{padding:16px 20px; border-top:1px solid var(--ring); display:flex; justify-content:space-between; align-items:center}

    .empty-state{text-align:center; padding:80px 20px; color:var(--muted); background:var(--card); border:1px solid var(--ring); border-radius:16px}

    /* Upload modal */
    .upload-modal{display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:1001; align-items:center; justify-content:center; padding:20px}
    .upload-modal.active{display:flex}
    .upload-content{background:var(--card); border:1px solid var(--ring); border-radius:16px; max-width:500px; width:100%; padding:24px}
    .upload-title{font-size:20px; font-weight:700; color:var(--text); margin-bottom:16px}
    .upload-form{display:grid; gap:16px}
    .form-group label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    .form-group input, .form-group textarea{width:100%; padding:10px 12px; background:var(--sunken); border:1px solid var(--ring); border-radius:8px; color:var(--text); font-size:14px; font-family:inherit}
    .form-group textarea{min-height:80px; resize:vertical}
    .file-input{cursor:pointer}
    .upload-actions{display:flex; gap:8px; justify-content:flex-end}
  </style>
</head>
<body>
  <div class="header">
    <a href="/static/generate.html" class="logo">
      <img src="/logo.png" alt="Mini Visionary Logo">
      Mini Visionary
    </a>
    <nav class="nav">
      <a href="/static/guide.html">Guide</a>
      <a href="/static/gallery.html" class="active">Gallery</a>
      <a href="/static/library.html">Library</a>
      <a href="/static/store.html">💎 Store</a>
      <a href="/static/wallet.html">💰 Wallet</a>
      <a href="/static/profile.html">🧑 Profile</a>
    </nav>
  </div>

  <div class="container">
    <h1>🎨 Community Gallery</h1>
    <p class="subtitle">Explore masterpieces from the Mini Visionary community. Share your art and react to others.</p>

    <div class="filter-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div style="font-size: 18px; font-weight: 600; color: var(--text);">
          💎 Credits: <span id="user-credits" style="color: var(--btn-start);">Loading...</span>
        </div>
        <div style="font-size: 13px; color: var(--muted);">
          Posting costs 3 credits
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" onclick="openUploadModal()">📤 Post Your Masterpiece</button>
        <button class="btn btn-clear" onclick="scrollToTop()">Back to top</button>
      </div>
    </div>

    <div id="gallery-grid" class="gallery-grid"></div>
    <div id="empty-state" class="empty-state" style="display:none;">
      <h2 style="color:var(--text); margin-bottom:16px;">No results</h2>
      <p>Try a different keyword, date range, or clear filters.</p>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="modal" class="modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" id="modal-title"></div>
        <div class="modal-actions">
          <button class="btn btn-primary" onclick="saveImage()">Save</button>
          <button class="btn btn-clear" onclick="closeModal()">Close</button>
        </div>
      </div>
      <img id="modal-img" class="modal-img" src="" alt="">
      <div class="modal-footer">
        <div class="gallery-tags" id="modal-tags"></div>
        <div class="gallery-date" id="modal-date"></div>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div id="upload-modal" class="upload-modal" onclick="closeUploadModal()">
    <div class="upload-content" onclick="event.stopPropagation()">
      <div class="upload-title">📤 Upload Image to Gallery</div>
      <form class="upload-form" onsubmit="uploadImage(event)">
        <div class="form-group">
          <label>Image File</label>
          <input type="file" id="upload-file" class="file-input" accept="image/*" required>
        </div>
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="upload-prompt" placeholder="Give your masterpiece a title..." required>
        </div>
        <div class="form-group">
          <label>Story / Inspiration (optional)</label>
          <textarea id="upload-story" placeholder="Share the story behind your art..."></textarea>
        </div>
        <div class="form-group">
          <label>Tags (comma-separated)</label>
          <input type="text" id="upload-tags" placeholder="e.g. poster, neon, portrait">
        </div>
        <div class="upload-actions">
          <button type="button" class="btn btn-clear" onclick="closeUploadModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Post</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Check authentication
    const token = localStorage.getItem('jwt_token');
    if (!token) {
      window.location.href = '/auth.html#login';
    }

    // Gallery state
    let galleryItems = [];
    let currentModal = null;
    let currentUserId = null;

    // Save user reactions per user
    function saveUserReaction(postId, reactionType) {
      if (!currentUserId) return;
      const key = `mv_user_reactions_${currentUserId}`;
      const reactions = JSON.parse(localStorage.getItem(key) || '{}');
      reactions[postId] = reactionType;
      localStorage.setItem(key, JSON.stringify(reactions));
    }

    // Load user reactions for current user
    function getUserReaction(postId) {
      if (!currentUserId) return null;
      const key = `mv_user_reactions_${currentUserId}`;
      const reactions = JSON.parse(localStorage.getItem(key) || '{}');
      return reactions[postId] || null;
    }

    // Load demo data with real category images organized by category
    function loadDemoData() {
      const categoryImages = [
        // Fantasy category
        {url: '/Fantasy Images/fantasy1.jpg', prompt: 'Fantasy Adventure', tags: ['fantasy', 'adventure'], category: 'fantasy'},
        {url: '/Fantasy Images/fantasy_dark-knight-flame_1024x1536.jpg', prompt: 'Dark Knight with Flame', tags: ['fantasy', 'knight', 'fire'], category: 'fantasy'},
        {url: '/Fantasy Images/fantasy_light-angel_1024x1536.jpg', prompt: 'Light Angel Guardian', tags: ['fantasy', 'angel', 'light'], category: 'fantasy'},
        {url: '/Fantasy Images/fantasy_dark-angel_1024x1536.jpg', prompt: 'Dark Angel Warrior', tags: ['fantasy', 'angel', 'dark'], category: 'fantasy'},
        {url: '/Fantasy Images/fantasy_spirit-wolf-aura_1024x1536.jpg', prompt: 'Spirit Wolf with Aura', tags: ['fantasy', 'wolf', 'spirit'], category: 'fantasy'},
        {url: '/Fantasy Images/fantasy_angel-vs-demon-dual_1024x1536.jpg', prompt: 'Angel vs Demon', tags: ['fantasy', 'angel', 'demon'], category: 'fantasy'},
        {url: '/Fantasy Images/fantasy_angelic-paladin-flamesword_1024x1536.jpg', prompt: 'Angelic Paladin', tags: ['fantasy', 'paladin', 'angel'], category: 'fantasy'},
        {url: '/Fantasy Images/fantasy_halo-dualblades-sentinel_1024x1536.jpg', prompt: 'Dual Blades Sentinel', tags: ['fantasy', 'sentinel', 'warrior'], category: 'fantasy'},
        {url: '/Fantasy Images/fantasy_halo-spear-guardian_1024x1536.jpg', prompt: 'Spear Guardian', tags: ['fantasy', 'guardian', 'warrior'], category: 'fantasy'},
        {url: '/Fantasy Images/fantasy_rune-wolf-storm_1024x1536.jpg', prompt: 'Rune Wolf Storm', tags: ['fantasy', 'wolf', 'rune'], category: 'fantasy'},
        {url: '/Fantasy Images/fantasy_elemental-fairy-firewater_1024x1536.jpg', prompt: 'Elemental Fairy', tags: ['fantasy', 'fairy', 'elemental'], category: 'fantasy'},
        {url: '/Fantasy Images/fantasy_cute-celestial-mage_1024x1024.jpg', prompt: 'Celestial Mage', tags: ['fantasy', 'mage', 'celestial'], category: 'fantasy'},
        {url: '/Fantasy Images/fantasy_fantasy-castle-themepark_1024x1024.jpg', prompt: 'Fantasy Castle', tags: ['fantasy', 'castle', 'kingdom'], category: 'fantasy'},

        // Horror category
        {url: '/Fantasy Images/horror_dark-reaper-angel_1024x1536.jpg', prompt: 'Dark Reaper Angel', tags: ['horror', 'reaper', 'dark'], category: 'horror'},
        {url: '/Fantasy Images/horror_pumpkin-rider_1024x1536.jpg', prompt: 'Pumpkin Rider', tags: ['horror', 'halloween', 'rider'], category: 'horror'},
        {url: '/Fantasy Images/horror_cerberus-hellhound_1024x1536.jpg', prompt: 'Cerberus Hellhound', tags: ['horror', 'cerberus', 'hellhound'], category: 'horror'},

        // Anime category
        {url: '/Fantasy Images/anime.jpg', prompt: 'Anime Character', tags: ['anime', 'character'], category: 'anime'},
        {url: '/Fantasy Images/anime_anime-fox-dragonflame_1024x1536.jpg', prompt: 'Fox Dragon Flame', tags: ['anime', 'fox', 'dragon'], category: 'anime'},

        // Sci-Fi category
        {url: '/Fantasy Images/scifi.jpg', prompt: 'Sci-Fi Future', tags: ['sci-fi', 'future', 'technology'], category: 'sci-fi'},
        {url: '/Fantasy Images/scifi_cybernetic-tiger-cub_1024x1024.jpg', prompt: 'Cybernetic Tiger Cub', tags: ['sci-fi', 'cybernetic', 'tiger'], category: 'sci-fi'},

        // Action category
        {url: '/Fantasy Images/action.jpg', prompt: 'Action Hero', tags: ['action', 'hero', 'adventure'], category: 'action'},

        // Romance category
        {url: '/Fantasy Images/romance.jpg', prompt: 'Romance Story', tags: ['romance', 'love', 'story'], category: 'romance'}
      ];

      galleryItems = categoryImages.map((img, i) => {
        const postId = `demo_${i+1}`;
        return {
          id: postId,
          url: img.url,
          prompt: img.prompt,
          story: "",
          createdAt: new Date(Date.now() - i * 3600000).toISOString(),
          tags: img.tags,
          reactions: {love: 0, magic: 0, peace: 0, fire: 0, gratitude: 0, star: 0, applause: 0, support: 0},
          userReacted: getUserReaction(postId)  // Load user's reaction from localStorage
        };
      });

      // Load from localStorage
      const saved = localStorage.getItem('mv_gallery_items');
      if (saved) {
        try {
          const savedItems = JSON.parse(saved);
          // Apply user reactions to saved items too
          savedItems.forEach(item => {
            item.userReacted = getUserReaction(item.id);
          });
          galleryItems = [...savedItems, ...galleryItems];
        } catch(e) {
          console.error('Failed to load saved items:', e);
        }
      }

      renderGallery();
    }

    // Render gallery - simple community showcase
    function renderGallery() {
      // Sort by newest first
      const sorted = [...galleryItems].sort((a, b) => {
        return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
      });

      const grid = document.getElementById('gallery-grid');
      const empty = document.getElementById('empty-state');

      if (sorted.length === 0) {
        grid.innerHTML = '';
        empty.style.display = 'block';
      } else {
        empty.style.display = 'none';
        grid.innerHTML = sorted.map(item => `
          <div class="gallery-item" data-id="${item.id}">
            <img src="${item.url}" alt="${item.prompt}" onclick="openModal('${item.id}')">
            <div class="gallery-info">
              <div class="gallery-title" title="${item.prompt}">${item.prompt}</div>
              ${item.story ? `<div style="font-size:13px; color:var(--muted); margin:8px 0; line-height:1.4;">${item.story}</div>` : ''}
              <div class="gallery-meta">
                <div class="gallery-date">${new Date(item.createdAt).toLocaleString()}</div>
              </div>
              <div class="gallery-tags">
                ${item.tags.map(t => `<span class="tag">${t}</span>`).join('')}
              </div>
              <div class="gallery-actions">
                <div class="gallery-reactions">
                  <button class="reaction-btn ${item.userReacted === 'love' ? 'active' : ''}" onclick="toggleReaction('${item.id}', 'love')">
                    ❤️ ${item.reactions.love}
                  </button>
                  <button class="reaction-btn ${item.userReacted === 'magic' ? 'active' : ''}" onclick="toggleReaction('${item.id}', 'magic')">
                    ✨ ${item.reactions.magic}
                  </button>
                  <button class="reaction-btn ${item.userReacted === 'peace' ? 'active' : ''}" onclick="toggleReaction('${item.id}', 'peace')">
                    🌿 ${item.reactions.peace}
                  </button>
                  <button class="reaction-btn ${item.userReacted === 'fire' ? 'active' : ''}" onclick="toggleReaction('${item.id}', 'fire')">
                    🔥 ${item.reactions.fire}
                  </button>
                  <button class="reaction-btn ${item.userReacted === 'gratitude' ? 'active' : ''}" onclick="toggleReaction('${item.id}', 'gratitude')">
                    🙏 ${item.reactions.gratitude}
                  </button>
                  <button class="reaction-btn ${item.userReacted === 'star' ? 'active' : ''}" onclick="toggleReaction('${item.id}', 'star')">
                    ⭐ ${item.reactions.star}
                  </button>
                  <button class="reaction-btn ${item.userReacted === 'applause' ? 'active' : ''}" onclick="toggleReaction('${item.id}', 'applause')">
                    👏 ${item.reactions.applause}
                  </button>
                  <button class="reaction-btn ${item.userReacted === 'support' ? 'active' : ''}" onclick="toggleReaction('${item.id}', 'support')">
                    🫶 ${item.reactions.support}
                  </button>
                </div>
                <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
                  Total reactions: ${Object.values(item.reactions).reduce((a, b) => a + b, 0)}
                </div>
                ${item.id.startsWith('uploaded_') ? `<button class="btn-delete" onclick="deleteImage('${item.id}')">🗑️ Delete</button>` : ''}
              </div>
            </div>
          </div>
        `).join('');
      }
    }

    function toggleReaction(id, type) {
      const item = galleryItems.find(i => i.id === id);
      if (!item) return;

      const reactionEmojis = {
        'love': '❤️',
        'magic': '✨',
        'peace': '🌿',
        'fire': '🔥',
        'gratitude': '🙏',
        'star': '⭐',
        'applause': '👏',
        'support': '🫶'
      };

      // Check if user already reacted
      if (item.userReacted) {
        const existingEmoji = reactionEmojis[item.userReacted];
        alert(`You've already reacted to this post!\n\n${existingEmoji} Your ${item.userReacted} reaction is locked in.\n\n⚠️ You can only react once per post - reactions are permanent and cannot be changed.`);
        return;
      }

      // Show confirmation prompt
      const emoji = reactionEmojis[type];
      const confirmed = confirm(`Confirm Permanent Reaction\n${emoji}\n\nAre you sure you want to react with ${emoji}?\n\n⚠️ This reaction is permanent and cannot be changed or removed!`);

      if (!confirmed) return;

      // Add the reaction
      item.reactions[type]++;
      item.userReacted = type;

      // Save user reaction to localStorage
      saveUserReaction(item.id, type);

      saveGallery();
      renderGallery();
    }

    function deleteImage(id) {
      if (!confirm('Delete this image from the gallery?')) return;

      galleryItems = galleryItems.filter(i => i.id !== id);
      saveGallery();
      renderGallery();
    }

    function openModal(id) {
      const item = galleryItems.find(i => i.id === id);
      if (!item) return;

      currentModal = item;
      document.getElementById('modal-title').textContent = item.prompt;
      document.getElementById('modal-img').src = item.url;
      document.getElementById('modal-tags').innerHTML = item.tags.map(t => `<span class="tag">${t}</span>`).join('');
      document.getElementById('modal-date').textContent = new Date(item.createdAt).toLocaleString();
      document.getElementById('modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      currentModal = null;
    }

    function saveImage() {
      if (!currentModal) return;
      alert('Image saved to your library! (Feature coming soon)');
    }

    function openUploadModal() {
      document.getElementById('upload-modal').classList.add('active');
    }

    function closeUploadModal() {
      document.getElementById('upload-modal').classList.remove('active');
      document.getElementById('upload-file').value = '';
      document.getElementById('upload-prompt').value = '';
      document.getElementById('upload-story').value = '';
      document.getElementById('upload-tags').value = '';
    }

    async function uploadImage(event) {
      event.preventDefault();

      const fileInput = document.getElementById('upload-file');
      const prompt = document.getElementById('upload-prompt').value;
      const story = document.getElementById('upload-story').value;
      const tagsInput = document.getElementById('upload-tags').value;
      const tags = tagsInput.split(',').map(t => t.trim()).filter(t => t);

      if (!fileInput.files[0]) return;

      // Check user credits first
      try {
        const response = await fetch('/api/auth/whoami', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await response.json();

        if (!data.ok || !data.user) {
          alert('Failed to verify your account. Please try again.');
          return;
        }

        const userCredits = data.user.credits || 0;

        if (userCredits < 3) {
          alert(`Insufficient credits!\n\nYou need 3 credits to post to the gallery.\nYou currently have ${userCredits} credits.\n\nVisit the Store to purchase more credits.`);
          closeUploadModal();
          return;
        }

        // Confirm the cost
        const confirmed = confirm(`Post to Gallery\n\nThis will cost 3 credits.\n\nYou have ${userCredits} credits.\nAfter posting, you'll have ${userCredits - 3} credits.\n\nDo you want to continue?`);

        if (!confirmed) return;

        // Deduct credits (call backend API)
        const deductResponse = await fetch('/api/gallery/post', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            prompt: prompt,
            story: story,
            tags: tags
          })
        });

        const deductData = await deductResponse.json();

        if (!deductData.ok) {
          alert(`Failed to post: ${deductData.error || 'Unknown error'}`);
          return;
        }

        // Upload succeeded, add to gallery
        const reader = new FileReader();
        reader.onload = (e) => {
          const newItem = {
            id: `uploaded_${Date.now()}`,
            url: e.target.result,
            prompt: prompt,
            story: story,
            createdAt: new Date().toISOString(),
            tags: tags.length > 0 ? tags : ['custom'],
            reactions: {love: 0, magic: 0, peace: 0, fire: 0, gratitude: 0, star: 0, applause: 0, support: 0},
            userReacted: null
          };

          galleryItems.unshift(newItem);
          saveGallery();
          renderGallery();
          closeUploadModal();

          // Reload credits display
          loadUserCredits();

          alert(`✅ Posted successfully!\n\n3 credits deducted.\nRemaining credits: ${userCredits - 3}`);
        };

        reader.readAsDataURL(fileInput.files[0]);

      } catch (error) {
        console.error('Upload error:', error);
        alert('Failed to post. Please try again.');
      }
    }

    function saveGallery() {
      const userUploads = galleryItems.filter(i => i.id.startsWith('uploaded_'));
      localStorage.setItem('mv_gallery_items', JSON.stringify(userUploads));
    }

    function scrollToTop() {
      window.scrollTo({top: 0, behavior: 'smooth'});
    }

    // Load user credits and ID
    async function loadUserCredits() {
      try {
        const response = await fetch('/api/auth/whoami', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await response.json();
        if (data.ok && data.user) {
          currentUserId = data.user.id;
          document.getElementById('user-credits').textContent = data.user.credits || 0;
          // Reload demo data to apply user reactions
          loadDemoData();
        } else {
          document.getElementById('user-credits').textContent = '0';
        }
      } catch (error) {
        console.error('Failed to load credits:', error);
        document.getElementById('user-credits').textContent = '0';
      }
    }

    // Initialize - load user first, then data
    loadUserCredits();
  </script>
</body>
</html>