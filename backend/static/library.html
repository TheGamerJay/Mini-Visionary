<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Library — Mini Visionary</title>
  <link rel="icon" href="/logo.png" />
  <style>
    :root{
      --bg-0:#0b0f19; --bg-1:#0f1629; --card:#0e1424; --sunken:#0b1020;
      --line:#3b82f6; --text:#e6eaf2; --muted:#9aa4b2; --ring:rgba(148,163,184,.25);
      --btn-start:#22d3ee; --btn-end:#ec4899;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text); min-height:100vh; display:flex; flex-direction:column;
      background:
        radial-gradient(1200px 600px at 10% -10%, #16213a 0%, transparent 60%),
        radial-gradient(1200px 600px at 110% 110%, #1b2a4b 0%, transparent 60%),
        linear-gradient(180deg, var(--bg-0), var(--bg-1));
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    }
    .header{display:flex; justify-content:space-between; align-items:center; padding:16px 24px; border-bottom:1px solid var(--ring)}
    .logo{display:flex; align-items:center; gap:12px; font-size:20px; font-weight:700; text-decoration:none; color:var(--text)}
    .logo img{width:32px; height:32px; border-radius:8px}
    .nav{display:flex; gap:16px; align-items:center}
    .nav a{color:var(--muted); text-decoration:none; padding:8px 12px; border-radius:8px; transition:all 0.2s}
    .nav a:hover, .nav a.active{color:var(--text); background:var(--sunken)}
    .container{max-width:1600px; margin:0 auto; padding:40px 24px}

    /* Hero */
    .hero{margin-bottom:40px}
    .hero-title{font-size:48px; font-weight:800; margin:0 0 12px 0; background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); background-clip:text; -webkit-background-clip:text; color:transparent}
    .hero-subtitle{color:var(--muted); font-size:18px; margin:0}

    /* Toolbar */
    .toolbar{display:flex; justify-content:space-between; align-items:center; margin-bottom:32px; flex-wrap:wrap; gap:16px}
    .toolbar-left{display:flex; gap:8px; flex-wrap:wrap}
    .filter-btn{padding:10px 20px; background:var(--card); border:1px solid var(--ring); border-radius:12px; color:var(--muted); cursor:pointer; transition:all 0.2s; font-size:14px; font-weight:600}
    .filter-btn:hover{border-color:var(--line); color:var(--text)}
    .filter-btn.active{background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); color:#081018; border:none}
    .toolbar-right{display:flex; gap:8px}
    .btn{padding:10px 20px; border-radius:12px; font-size:14px; cursor:pointer; transition:all 0.2s; border:none; font-weight:600}
    .btn-secondary{background:var(--card); border:1px solid var(--ring); color:var(--text)}
    .btn-secondary:hover{background:var(--sunken); border-color:var(--line); transform:translateY(-1px)}
    .btn-primary{background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); color:#081018}
    .btn-primary:hover{transform:translateY(-2px); box-shadow:0 8px 24px rgba(34,211,238,0.3)}

    /* Grid layout */
    .library-grid{
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:24px;
      margin-top:24px;
    }
    @media (max-width: 1200px) { .library-grid{grid-template-columns:repeat(3, 1fr)} }
    @media (max-width: 768px) { .library-grid{grid-template-columns:repeat(2, 1fr); gap:16px} }
    @media (max-width: 480px) { .library-grid{grid-template-columns:1fr} }

    .library-item{
      background:var(--card);
      border:1px solid var(--ring);
      border-radius:16px;
      overflow:hidden;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor:pointer;
      position:relative;
      display:flex;
      flex-direction:column;
    }
    .library-item:hover{
      border-color:var(--line);
      transform:translateY(-4px);
      box-shadow:0 12px 32px rgba(0,0,0,0.4);
    }

    .library-item-image{
      width:100%;
      aspect-ratio:3/4;
      background:var(--sunken);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .library-item-image img{
      width:100%;
      height:100%;
      object-fit:cover;
      transition:transform 0.3s;
    }
    .library-item:hover .library-item-image img{
      transform:scale(1.05);
    }

    .library-item-folder{
      width:100%;
      aspect-ratio:3/4;
      background:linear-gradient(135deg, var(--card), var(--sunken));
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:64px;
      position:relative;
    }
    .library-item-folder::before{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(135deg, rgba(34,211,238,0.1), rgba(236,72,153,0.1));
      opacity:0;
      transition:opacity 0.3s;
    }
    .library-item:hover .library-item-folder::before{
      opacity:1;
    }

    .library-item-info{
      padding:16px;
      flex:1;
      display:flex;
      flex-direction:column;
    }
    .library-item-name{
      font-size:15px;
      font-weight:600;
      color:var(--text);
      margin:0 0 6px 0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .library-item-meta{
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .library-item-actions{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:12px;
      opacity:0;
      transform:translateY(4px);
      transition:all 0.2s;
    }
    .library-item:hover .library-item-actions{
      opacity:1;
      transform:translateY(0);
    }
    .btn-icon{
      padding:8px 12px;
      background:var(--sunken);
      border:1px solid var(--ring);
      border-radius:8px;
      color:var(--text);
      cursor:pointer;
      font-size:12px;
      transition:all 0.2s;
      display:flex;
      align-items:center;
      gap:6px;
      width:100%;
      justify-content:center;
      white-space:nowrap;
    }
    .btn-icon:hover{
      border-color:var(--line);
      background:var(--card);
    }
    .btn-delete{
      background:#ef4444;
      border:none;
      color:white;
    }
    .btn-delete:hover{
      background:#dc2626;
    }

    .empty-state{
      text-align:center;
      padding:120px 40px;
      color:var(--muted);
    }
    .empty-state-icon{
      font-size:72px;
      margin-bottom:24px;
      opacity:0.5;
    }
    .empty-state h2{
      color:var(--text);
      font-size:28px;
      font-weight:700;
      margin:0 0 12px 0;
    }
    .empty-state p{
      font-size:16px;
      margin:0 0 24px 0;
    }

    /* Modal */
    .modal{
      display:none;
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.85);
      backdrop-filter:blur(8px);
      z-index:1000;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .modal.active{display:flex}
    .modal-content{
      background:var(--card);
      border:1px solid var(--ring);
      border-radius:20px;
      max-width:500px;
      width:100%;
      padding:32px;
      box-shadow:0 20px 60px rgba(0,0,0,0.6);
    }
    .modal-title{
      font-size:24px;
      font-weight:700;
      color:var(--text);
      margin:0 0 24px 0;
    }
    .modal-form{
      display:grid;
      gap:20px;
    }
    .form-group label{
      display:block;
      font-size:13px;
      font-weight:600;
      color:var(--muted);
      margin-bottom:8px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .form-group input{
      width:100%;
      padding:12px 16px;
      background:var(--sunken);
      border:1px solid var(--ring);
      border-radius:12px;
      color:var(--text);
      font-size:15px;
      transition:all 0.2s;
    }
    .form-group input:focus{
      outline:none;
      border-color:var(--line);
      background:var(--card);
    }
    .modal-actions{
      display:flex;
      gap:12px;
      justify-content:flex-end;
      margin-top:8px;
    }

    /* Image viewer */
    .image-viewer{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.95);
      backdrop-filter:blur(12px);
      z-index:9999;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      animation:fadeIn 0.2s;
    }
    @keyframes fadeIn{
      from{opacity:0}
      to{opacity:1}
    }
    .image-viewer img{
      max-width:90%;
      max-height:90%;
      object-fit:contain;
      border-radius:12px;
      box-shadow:0 20px 80px rgba(0,0,0,0.8);
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="/static/generate.html" class="logo">
      <img src="/logo.png" alt="Mini Visionary Logo">
      Mini Visionary
    </a>
    <nav class="nav">
      <a href="/static/guide.html">Guide</a>
      <a href="/static/gallery.html">Gallery</a>
      <a href="/static/library.html" class="active">Library</a>
      <a href="/static/store.html">💎 Store</a>
      <a href="/static/wallet.html">💰 Wallet</a>
      <a href="/static/profile.html">🧑 Profile</a>
    </nav>
  </div>

  <div class="container">
    <div class="hero">
      <h1 class="hero-title">Your Library</h1>
      <p class="hero-subtitle">All your saved posters and collections in one place</p>
    </div>

    <div class="toolbar">
      <div class="toolbar-left">
        <button class="filter-btn active" onclick="filterLibrary('all')">All</button>
        <button class="filter-btn" onclick="filterLibrary('images')">Images</button>
        <button class="filter-btn" onclick="filterLibrary('folders')">Folders</button>
      </div>
      <div class="toolbar-right">
        <input type="file" id="file-input" style="display:none;" accept="image/*" onchange="uploadFile()">
        <button class="btn btn-secondary" onclick="document.getElementById('file-input').click()">📤 Upload</button>
        <button class="btn btn-primary" onclick="openNewFolderModal()">+ New Folder</button>
      </div>
    </div>

    <div id="library-grid" class="library-grid"></div>

    <div id="empty-state" class="empty-state" style="display:none;">
      <div class="empty-state-icon">📁</div>
      <h2>Your library is empty</h2>
      <p>Upload your first poster or create a folder to get started</p>
    </div>
  </div>

  <!-- New Folder Modal -->
  <div id="new-folder-modal" class="modal" onclick="closeNewFolderModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-title">Create New Folder</div>
      <form class="modal-form" onsubmit="createFolder(event)">
        <div class="form-group">
          <label>Folder Name</label>
          <input type="text" id="folder-name-input" placeholder="e.g. Movie Posters, Vintage Style..." required>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeNewFolderModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Folder</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Check authentication
    const token = localStorage.getItem('jwt_token');
    if (!token) {
      window.location.href = '/auth.html#login';
    }

    // Library state
    let library = [];
    let currentFilter = 'all';
    let deletingItems = new Set(); // Track items being deleted to prevent re-render

    // Load from localStorage
    function loadLibrary() {
      // Load from main library (saved from Mini Library)
      const mainLib = localStorage.getItem('mv_main_library');
      if (mainLib) {
        try {
          const mainImages = JSON.parse(mainLib);
          // Convert Mini Library format to Library format
          library = mainImages.map(img => ({
            id: img.id || `i_${Date.now()}_${Math.random()}`,
            name: img.prompt || 'Generated Image',
            type: 'image',
            url: img.url,
            timestamp: img.timestamp
          }));
        } catch(e) {
          console.error('Failed to load main library:', e);
        }
      }

      // Also check legacy mv_library
      const saved = localStorage.getItem('mv_library');
      if (saved) {
        try {
          const legacy = JSON.parse(saved);
          // Merge with main library, avoiding duplicates by ID
          legacy.forEach(item => {
            if (!library.some(l => l.id === item.id)) {
              library.push(item);
            }
          });
        } catch(e) {
          console.error('Failed to load library:', e);
        }
      }
    }

    function saveLibrary() {
      // Save back to main library
      const mainImages = library.filter(item => item.type === 'image').map(img => ({
        id: img.id,
        url: img.url,
        prompt: img.name,
        timestamp: img.timestamp || new Date().toISOString()
      }));
      localStorage.setItem('mv_main_library', JSON.stringify(mainImages));

      // Also save to legacy for backwards compatibility
      localStorage.setItem('mv_library', JSON.stringify(library));
    }

    // Filter library
    function filterLibrary(type) {
      currentFilter = type;

      // Update filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      renderLibrary();
    }

    // Render library
    function renderLibrary() {
      const grid = document.getElementById('library-grid');
      const empty = document.getElementById('empty-state');

      let items = library;

      // Filter out items being deleted
      items = items.filter(item => !deletingItems.has(item.id));

      // Apply filter
      if (currentFilter === 'images') {
        items = items.filter(item => item.type === 'image');
      } else if (currentFilter === 'folders') {
        items = items.filter(item => item.type === 'folder');
      }

      if (items.length === 0) {
        grid.style.display = 'none';
        empty.style.display = 'block';
      } else {
        empty.style.display = 'none';
        grid.style.display = 'grid';
        grid.innerHTML = items.map(item => {
          if (item.type === 'folder') {
            return `
              <div class="library-item" onclick="openFolder('${item.id}')">
                <div class="library-item-folder">📁</div>
                <div class="library-item-info">
                  <div class="library-item-name">${item.name}</div>
                  <div class="library-item-meta">
                    <span>${(item.children || []).length} items</span>
                  </div>
                  <div class="library-item-actions">
                    <button class="btn-icon btn-delete" onclick="event.stopPropagation(); deleteItem('${item.id}')">🗑️ Delete</button>
                  </div>
                </div>
              </div>
            `;
          } else {
            const timestamp = item.timestamp ? new Date(item.timestamp).toLocaleString() : 'Unknown date';
            return `
              <div class="library-item" onclick="viewImage('${item.id}')">
                <div class="library-item-image">
                  <img src="${item.url}" alt="${item.name}" onerror="handleImageError(this, '${item.id}')">
                </div>
                <div class="library-item-info">
                  <div class="library-item-name">${item.name}</div>
                  <div class="library-item-meta">
                    <span style="font-size:11px;color:var(--muted);">${timestamp}</span>
                  </div>
                  <div class="library-item-actions">
                    <button class="btn-icon" onclick="event.stopPropagation(); useAsReference('${item.id}')" title="Use as reference image">
                      🎨 Reference
                    </button>
                    <button class="btn-icon" onclick="event.stopPropagation(); downloadImage('${item.id}')" title="Download to device">
                      ⬇️ Download
                    </button>
                    <button class="btn-icon btn-delete" onclick="event.stopPropagation(); deleteItem('${item.id}')" title="Delete permanently">
                      🗑️ Delete
                    </button>
                  </div>
                </div>
              </div>
            `;
          }
        }).join('');
      }
    }

    // Create new folder
    function openNewFolderModal() {
      document.getElementById('new-folder-modal').classList.add('active');
      document.getElementById('folder-name-input').value = '';
      setTimeout(() => document.getElementById('folder-name-input').focus(), 100);
    }

    function closeNewFolderModal() {
      document.getElementById('new-folder-modal').classList.remove('active');
    }

    function createFolder(event) {
      event.preventDefault();
      const name = document.getElementById('folder-name-input').value.trim();
      if (!name) return;

      const newFolder = {
        id: `f_${Date.now()}`,
        name: name,
        type: 'folder',
        children: []
      };

      library.push(newFolder);
      saveLibrary();
      renderLibrary();
      closeNewFolderModal();
    }

    // Upload file
    function uploadFile() {
      const fileInput = document.getElementById('file-input');
      const file = fileInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const newImage = {
          id: `i_${Date.now()}`,
          name: file.name,
          type: 'image',
          url: e.target.result
        };

        library.push(newImage);
        saveLibrary();
        renderLibrary();
      };

      reader.readAsDataURL(file);
      fileInput.value = '';
    }

    // Handle image load errors (404s from missing posters)
    function handleImageError(img, itemId) {
      img.style.display = 'none';
      const container = img.parentElement;
      container.innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:8px;padding:20px;text-align:center;">
          <div style="color:var(--muted);font-size:32px;">❌</div>
          <div style="color:var(--muted);font-size:12px;">Image not found</div>
          <button class="btn-icon btn-delete" onclick="event.stopPropagation(); deleteItem('${itemId}', true)" style="margin-top:8px;">
            🗑️ Remove
          </button>
        </div>
      `;
    }

    // Delete item
    function deleteItem(id, skipConfirm = false) {
      if (!skipConfirm && !confirm('Delete this item? This cannot be undone.')) return;

      // Mark as deleting to prevent re-render
      deletingItems.add(id);

      // Remove from library immediately
      library = library.filter(item => item.id !== id);

      // Also remove from any folder's children
      library.forEach(item => {
        if (item.type === 'folder' && item.children) {
          item.children = item.children.filter(childId => childId !== id);
        }
      });

      saveLibrary();

      // Force re-render with clean slate
      const grid = document.getElementById('library-grid');
      if (grid) {
        grid.innerHTML = '';
        setTimeout(() => {
          renderLibrary();
          // Clear deleting flag after render
          deletingItems.delete(id);
        }, 10);
      }
    }

    // View image
    function viewImage(id) {
      const image = library.find(item => item.id === id);
      if (!image || !image.url) return;

      const viewer = document.createElement('div');
      viewer.className = 'image-viewer';

      const img = document.createElement('img');
      img.src = image.url;
      img.alt = image.name;

      viewer.appendChild(img);
      document.body.appendChild(viewer);

      viewer.onclick = () => viewer.remove();
    }

    // Use image as reference for generation
    async function useAsReference(id) {
      const image = library.find(item => item.id === id);
      if (!image || !image.url) return;

      try {
        // Get auth token
        const token = localStorage.getItem('jwt_token') || '';

        // Fetch the image as blob
        const response = await fetch(image.url, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          alert('Failed to load image as reference');
          return;
        }

        const blob = await response.blob();

        // Create a File object from the blob
        const file = new File([blob], image.name || 'reference.png', { type: 'image/png' });

        // Store in sessionStorage for the generate page
        const reader = new FileReader();
        reader.onload = (e) => {
          sessionStorage.setItem('reference_image_data', e.target.result);
          sessionStorage.setItem('reference_image_name', file.name);

          // Redirect to generate page
          window.location.href = '/generate.html';
        };
        reader.readAsDataURL(file);

      } catch (err) {
        alert(`Failed to use as reference: ${err.message}`);
      }
    }

    // Download image
    async function downloadImage(id) {
      const image = library.find(item => item.id === id);
      if (!image || !image.url) return;

      try {
        // Get auth token
        const token = localStorage.getItem('jwt_token') || '';

        // Fetch the image as blob with auth
        const response = await fetch(image.url, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          alert(`Failed to download: ${response.status === 404 ? 'Image not found' : 'Server error'}`);
          return;
        }

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = image.name || 'mini-visionary-image.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        // Clean up the blob URL
        setTimeout(() => URL.revokeObjectURL(url), 100);
      } catch (err) {
        console.error('Download failed:', err);
        alert(`Failed to download image: ${err.message}`);
      }
    }

    // Open folder (placeholder - can implement folder navigation later)
    function openFolder(id) {
      alert('Folder navigation coming soon! For now, folders are used to organize items.');
    }

    // Initialize
    loadLibrary();
    renderLibrary();
  </script>
</body>
</html>
