<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Library ‚Äî Mini Visionary</title>
  <link rel="icon" href="/logo.png" />
  <style>
    :root{
      --bg-0:#0b0f19; --bg-1:#0f1629; --card:#0e1424; --sunken:#0b1020;
      --line:#3b82f6; --text:#e6eaf2; --muted:#9aa4b2; --ring:rgba(148,163,184,.25);
      --btn-start:#22d3ee; --btn-end:#ec4899;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text); min-height:100vh; display:flex; flex-direction:column;
      background:
        radial-gradient(1200px 600px at 10% -10%, #16213a 0%, transparent 60%),
        radial-gradient(1200px 600px at 110% 110%, #1b2a4b 0%, transparent 60%),
        linear-gradient(180deg, var(--bg-0), var(--bg-1));
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    }
    .header{display:flex; justify-content:space-between; align-items:center; padding:16px 24px; border-bottom:1px solid var(--ring)}
    .logo{display:flex; align-items:center; gap:12px; font-size:20px; font-weight:700; text-decoration:none; color:var(--text)}
    .logo img{width:32px; height:32px; border-radius:8px}
    .nav{display:flex; gap:16px; align-items:center}
    .nav a{color:var(--muted); text-decoration:none; padding:8px 12px; border-radius:8px; transition:all 0.2s}
    .nav a:hover, .nav a.active{color:var(--text); background:var(--sunken)}
    .container{max-width:1400px; margin:0 auto; padding:40px 24px}
    h1{font-size:36px; font-weight:800; margin-bottom:16px; background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); background-clip:text; -webkit-background-clip:text; color:transparent}

    /* Layout */
    .library-layout{display:grid; grid-template-columns:320px 1fr; gap:24px; margin-top:32px}
    @media (max-width: 1024px) { .library-layout{grid-template-columns:1fr} }

    /* Sidebar */
    .sidebar{background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:20px; height:fit-content}
    .sidebar-title{font-size:14px; font-weight:600; color:var(--text); margin-bottom:16px}
    .tree{padding-left:8px; border-left:1px solid var(--ring)}
    .tree-item{padding:12px 8px; display:flex; align-items:center; gap:8px; cursor:pointer; border-radius:8px; transition:all 0.2s; margin:4px 0}
    .tree-item:hover{background:var(--sunken)}
    .tree-item.active{background:var(--sunken); border-left:2px solid var(--line)}
    .tree-item-icon{width:20px; text-align:center; font-size:18px}
    .tree-item-name{font-size:14px; color:var(--text); flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .tree-item-count{font-size:11px; color:var(--muted); background:var(--sunken); padding:2px 6px; border-radius:4px}
    .tree-children{padding-left:16px; margin-left:8px; border-left:1px solid var(--ring)}

    /* Main content */
    .main-content{background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:24px}
    .content-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; flex-wrap:wrap; gap:12px}
    .content-title{font-size:20px; font-weight:700; color:var(--text)}
    .content-actions{display:flex; gap:8px}
    .btn{padding:10px 20px; border-radius:8px; font-size:14px; cursor:pointer; transition:all 0.2s; border:none}
    .btn-secondary{background:var(--sunken); border:1px solid var(--ring); color:var(--text)}
    .btn-secondary:hover{background:var(--card); border-color:var(--line)}
    .btn-primary{background:linear-gradient(90deg, var(--btn-start), var(--btn-end)); color:#081018; font-weight:700}
    .btn-primary:hover{transform:translateY(-1px)}

    /* Grid */
    .library-grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:16px}
    @media (max-width: 640px) { .library-grid{grid-template-columns:repeat(auto-fill, minmax(150px, 1fr))} }

    .library-item{background:var(--sunken); border:1px solid var(--ring); border-radius:12px; padding:16px; transition:all 0.2s; cursor:pointer; position:relative}
    .library-item:hover{border-color:var(--line); transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,0.3)}
    .library-item-icon{font-size:48px; text-align:center; margin-bottom:12px}
    .library-item-name{font-size:14px; font-weight:600; color:var(--text); margin-bottom:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .library-item-meta{font-size:11px; color:var(--muted)}
    .library-item-actions{display:flex; gap:4px; margin-top:12px; opacity:0; transition:opacity 0.2s}
    .library-item:hover .library-item-actions{opacity:1}
    .btn-icon{padding:6px; background:var(--card); border:1px solid var(--ring); border-radius:6px; color:var(--text); cursor:pointer; font-size:12px; transition:all 0.2s}
    .btn-icon:hover{border-color:var(--line)}
    .btn-delete{background:#ef4444; border:none; color:white}
    .btn-delete:hover{background:#dc2626}

    .empty-state{text-align:center; padding:80px 20px; color:var(--muted)}

    /* New folder modal */
    .modal{display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center; padding:20px}
    .modal.active{display:flex}
    .modal-content{background:var(--card); border:1px solid var(--ring); border-radius:16px; max-width:400px; width:100%; padding:24px}
    .modal-title{font-size:20px; font-weight:700; color:var(--text); margin-bottom:16px}
    .modal-form{display:grid; gap:16px}
    .form-group label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    .form-group input{width:100%; padding:10px 12px; background:var(--sunken); border:1px solid var(--ring); border-radius:8px; color:var(--text); font-size:14px}
    .form-group input:focus{outline:none; border-color:var(--line)}
    .modal-actions{display:flex; gap:8px; justify-content:flex-end}
  </style>
</head>
<body>
  <div class="header">
    <a href="/static/generate.html" class="logo">
      <img src="/logo.png" alt="Mini Visionary Logo">
      Mini Visionary
    </a>
    <nav class="nav">
      <a href="/static/guide.html">Guide</a>
      <a href="/static/gallery.html">Gallery</a>
      <a href="/static/library.html" class="active">Library</a>
      <a href="/static/store.html">üíé Store</a>
      <a href="/static/wallet.html">üí∞ Wallet</a>
      <a href="/static/profile.html">üßë Profile</a>
    </nav>
  </div>

  <div class="container">
    <h1>üìÅ Your Library</h1>
    <p style="color:var(--muted); margin-bottom:24px;">All your saved posters organized in folders.</p>

    <div class="library-layout">
      <!-- Sidebar with folder tree -->
      <div class="sidebar">
        <div class="sidebar-title">Folders</div>
        <div id="folder-tree" class="tree"></div>
      </div>

      <!-- Main content -->
      <div class="main-content">
        <div class="content-header">
          <div class="content-title" id="current-folder-name">Library</div>
          <div class="content-actions">
            <input type="file" id="file-input" style="display:none;" accept="image/*" onchange="uploadFile()">
            <button class="btn btn-secondary" onclick="document.getElementById('file-input').click()">üì§ Upload</button>
            <button class="btn btn-primary" onclick="openNewFolderModal()">üìÅ New Folder</button>
          </div>
        </div>

        <div id="library-grid" class="library-grid"></div>

        <div id="empty-state" class="empty-state" style="display:none;">
          <h2 style="color:var(--text); margin-bottom:16px;">This folder is empty</h2>
          <p>Upload images or create subfolders to organize your library.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- New Folder Modal -->
  <div id="new-folder-modal" class="modal" onclick="closeNewFolderModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-title">üìÅ Create New Folder</div>
      <form class="modal-form" onsubmit="createFolder(event)">
        <div class="form-group">
          <label>Folder Name</label>
          <input type="text" id="folder-name-input" placeholder="e.g. Posters, Moodboards..." required>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeNewFolderModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Check authentication
    const token = localStorage.getItem('jwt_token');
    if (!token) {
      window.location.href = '/auth.html#login';
    }

    // Library state
    let library = [
      { id: "f1", name: "Posters", type: "folder", children: [
        { id: "i1", name: "NeonConcert.png", type: "image", url: "https://picsum.photos/seed/neon1/400/600" },
        { id: "i2", name: "VaporPortrait.jpg", type: "image", url: "https://picsum.photos/seed/vapor1/400/600" },
      ]},
      { id: "f2", name: "Moodboards", type: "folder", children: [
        { id: "i3", name: "Palette01.png", type: "image", url: "https://picsum.photos/seed/palette1/400/400" },
      ]},
    ];

    let currentFolderId = null;

    // Load from localStorage
    function loadLibrary() {
      const saved = localStorage.getItem('mv_library');
      if (saved) {
        try {
          library = JSON.parse(saved);
        } catch(e) {
          console.error('Failed to load library:', e);
        }
      }
    }

    function saveLibrary() {
      localStorage.setItem('mv_library', JSON.stringify(library));
    }

    // Render folder tree
    function renderFolderTree() {
      const tree = document.getElementById('folder-tree');
      tree.innerHTML = renderTreeNodes(library);
    }

    function renderTreeNodes(nodes, level = 0) {
      return nodes.map(node => {
        if (node.type === 'folder') {
          const childCount = (node.children || []).length;
          const isActive = currentFolderId === node.id;
          return `
            <div>
              <div class="tree-item ${isActive ? 'active' : ''}" onclick="selectFolder('${node.id}')">
                <span class="tree-item-icon">üìÅ</span>
                <span class="tree-item-name">${node.name}</span>
                <span class="tree-item-count">${childCount}</span>
              </div>
              ${node.children && node.children.some(c => c.type === 'folder') ?
                `<div class="tree-children">${renderTreeNodes(node.children.filter(c => c.type === 'folder'), level + 1)}</div>`
                : ''}
            </div>
          `;
        }
        return '';
      }).join('');
    }

    // Select folder
    function selectFolder(folderId) {
      currentFolderId = folderId;
      renderFolderTree();
      renderLibraryGrid();
    }

    // Render library grid
    function renderLibraryGrid() {
      const grid = document.getElementById('library-grid');
      const empty = document.getElementById('empty-state');
      const folderNameEl = document.getElementById('current-folder-name');

      let items = [];
      let folderName = 'Library';

      if (currentFolderId) {
        const folder = findNodeById(library, currentFolderId);
        if (folder) {
          items = folder.children || [];
          folderName = folder.name;
        }
      } else {
        items = library;
      }

      folderNameEl.textContent = folderName;

      if (items.length === 0) {
        grid.innerHTML = '';
        empty.style.display = 'block';
      } else {
        empty.style.display = 'none';
        grid.innerHTML = items.map(item => `
          <div class="library-item" onclick="${item.type === 'folder' ? `selectFolder('${item.id}')` : `viewImage('${item.id}')`}">
            <div class="library-item-icon">${item.type === 'folder' ? 'üìÅ' : 'üñºÔ∏è'}</div>
            <div class="library-item-name" title="${item.name}">${item.name}</div>
            <div class="library-item-meta">${item.type === 'folder' ? `${(item.children || []).length} items` : 'Image'}</div>
            <div class="library-item-actions">
              ${item.type === 'image' ? `<button class="btn-icon" onclick="event.stopPropagation(); downloadImage('${item.id}')">‚¨áÔ∏è</button>` : ''}
              <button class="btn-icon btn-delete" onclick="event.stopPropagation(); deleteItem('${item.id}')">üóëÔ∏è</button>
            </div>
          </div>
        `).join('');
      }
    }

    // Find node by ID
    function findNodeById(nodes, id) {
      for (const node of nodes) {
        if (node.id === id) return node;
        if (node.children) {
          const found = findNodeById(node.children, id);
          if (found) return found;
        }
      }
      return null;
    }

    // Create new folder
    function openNewFolderModal() {
      document.getElementById('new-folder-modal').classList.add('active');
      document.getElementById('folder-name-input').value = '';
    }

    function closeNewFolderModal() {
      document.getElementById('new-folder-modal').classList.remove('active');
    }

    function createFolder(event) {
      event.preventDefault();
      const name = document.getElementById('folder-name-input').value.trim();
      if (!name) return;

      const newFolder = {
        id: `f_${Date.now()}`,
        name: name,
        type: 'folder',
        children: []
      };

      if (currentFolderId) {
        const folder = findNodeById(library, currentFolderId);
        if (folder && folder.children) {
          folder.children.push(newFolder);
        }
      } else {
        library.push(newFolder);
      }

      saveLibrary();
      renderFolderTree();
      renderLibraryGrid();
      closeNewFolderModal();
    }

    // Upload file
    function uploadFile() {
      const fileInput = document.getElementById('file-input');
      const file = fileInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const newImage = {
          id: `i_${Date.now()}`,
          name: file.name,
          type: 'image',
          url: e.target.result
        };

        if (currentFolderId) {
          const folder = findNodeById(library, currentFolderId);
          if (folder && folder.children) {
            folder.children.push(newImage);
          }
        } else {
          // Add to first folder or create a default folder
          if (library.length === 0 || library[0].type !== 'folder') {
            library.unshift({
              id: `f_${Date.now()}`,
              name: 'My Images',
              type: 'folder',
              children: [newImage]
            });
          } else {
            library[0].children.push(newImage);
          }
        }

        saveLibrary();
        renderFolderTree();
        renderLibraryGrid();
      };

      reader.readAsDataURL(file);
      fileInput.value = '';
    }

    // Delete item
    function deleteItem(id) {
      if (!confirm('Delete this item?')) return;

      function removeFromNodes(nodes) {
        for (let i = 0; i < nodes.length; i++) {
          if (nodes[i].id === id) {
            nodes.splice(i, 1);
            return true;
          }
          if (nodes[i].children && removeFromNodes(nodes[i].children)) {
            return true;
          }
        }
        return false;
      }

      removeFromNodes(library);
      saveLibrary();
      renderFolderTree();
      renderLibraryGrid();
    }

    // View image
    function viewImage(id) {
      const image = findNodeById(library, id);
      if (image && image.url) {
        window.open(image.url, '_blank');
      }
    }

    // Download image
    function downloadImage(id) {
      const image = findNodeById(library, id);
      if (image && image.url) {
        const a = document.createElement('a');
        a.href = image.url;
        a.download = image.name;
        a.click();
      }
    }

    // Initialize
    loadLibrary();
    renderFolderTree();
    renderLibraryGrid();
  </script>
</body>
</html>